import React, { useState, useEffect, useMemo, useCallback, useRef, createContext, useContext } from 'react';
import { Search, Plus, Upload, Download, Settings, BarChart, Users, Moon, Sun, ChevronLeft, ChevronRight, Volume2, VolumeX, Image, Mic, X, Check, AlertCircle, Clock, Brain, Zap, Target, Award, TrendingUp, Calendar, BookOpen, Shuffle, RotateCw, Play, Pause, ChevronDown, ChevronUp, Edit, Trash2, Copy, Filter, Tag, Layers, Grid, List, Move, ArrowUp, ArrowDown, Menu, Home } from 'lucide-react';

// ==================== Types ====================
interface MediaItem {
  id: string;
  type: 'image' | 'audio';
  data: string;
  caption?: string;
}

interface Card {
  id: string;
  question: string;
  answer: string;
  category: string;
  tags: string[];
  difficulty: 'easy' | 'medium' | 'hard';
  media: MediaItem[];
  created: string;
  lastStudied: string | null;
  nextReview: string | null;
  timesStudied: number;
  timesCorrect: number;
  easeFactor: number;
  interval: number;
  repetitions: number;
  lapses: number;
}

interface StudySession {
  id: string;
  date: string;
  duration: number;
  cardsStudied: number;
  correctCount: number;
  mode: StudyMode;
}

interface StudyStats {
  correct: number;
  incorrect: number;
  mastery: number;
}

interface AppState {
  cards: Card[];
  categories: Set<string>;
  studySessions: StudySession[];
  cardProgress: Record<string, StudyStats>;
  theme: 'light' | 'dark';
  settings: {
    dailyGoal: number;
    notificationsEnabled: boolean;
    soundEnabled: boolean;
    autoAdvance: boolean;
    studyReminders: string[];
    speechEnabled: boolean;
    speechRate: number;
    speechVoice: string;
    autoReadQuestion: boolean;
    autoReadAnswer: boolean;
  };
}

type StudyMode = 'standard' | 'quiz' | 'spaced' | 'timed' | 'marathon';
type ViewMode = 'grid' | 'list';

// ==================== Spaced Repetition Algorithm ====================
class SpacedRepetitionAlgorithm {
  private static readonly MIN_EASE_FACTOR = 1.3;
  private static readonly EASY_BONUS = 1.3;
  private static readonly HARD_PENALTY = 0.8;
  
  calculateInterval(card: Card, quality: number): Card {
    const updatedCard = { ...card };
    
    // Quality: 0-5 (0-2: fail, 3-5: pass)
    if (quality < 3) {
      // Failed
      updatedCard.interval = 1;
      updatedCard.repetitions = 0;
      updatedCard.lapses++;
    } else {
      // Passed
      if (updatedCard.repetitions === 0) {
        updatedCard.interval = 1;
      } else if (updatedCard.repetitions === 1) {
        updatedCard.interval = 6;
      } else {
        updatedCard.interval = Math.round(updatedCard.interval * updatedCard.easeFactor);
      }
      updatedCard.repetitions++;
    }
    
    // Update ease factor
    updatedCard.easeFactor = Math.max(
      SpacedRepetitionAlgorithm.MIN_EASE_FACTOR,
      updatedCard.easeFactor + 0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)
    );
    
    // Apply bonuses/penalties
    if (quality === 5) {
      updatedCard.interval = Math.round(updatedCard.interval * SpacedRepetitionAlgorithm.EASY_BONUS);
    } else if (quality === 3) {
      updatedCard.interval = Math.round(updatedCard.interval * SpacedRepetitionAlgorithm.HARD_PENALTY);
    }
    
    // Set next review date
    const nextReviewDate = new Date();
    nextReviewDate.setDate(nextReviewDate.getDate() + updatedCard.interval);
    updatedCard.nextReview = nextReviewDate.toISOString();
    updatedCard.lastStudied = new Date().toISOString();
    
    return updatedCard;
  }
  
  getCardsForReview(cards: Card[]): Card[] {
    const now = new Date();
    return cards.filter(card => {
      if (!card.nextReview) return true;
      return new Date(card.nextReview) <= now;
    }).sort((a, b) => {
      // Prioritize cards with more lapses
      if (a.lapses !== b.lapses) return b.lapses - a.lapses;
      // Then by interval (shorter intervals first)
      return a.interval - b.interval;
    });
  }
}

// ==================== Speech Service ====================
class SpeechService {
  private static synthesis = typeof window !== 'undefined' ? window.speechSynthesis : null;
  private static currentUtterance: SpeechSynthesisUtterance | null = null;
  
  static isSupported(): boolean {
    return typeof window !== 'undefined' && 'speechSynthesis' in window;
  }
  
  static getVoices(): SpeechSynthesisVoice[] {
    return this.synthesis?.getVoices() || [];
  }
  
  static speak(text: string, settings: AppState['settings']): Promise<void> {
    return new Promise((resolve, reject) => {
      if (!this.isSupported() || !settings.speechEnabled || !this.synthesis) {
        resolve();
        return;
      }
      
      // Cancel any ongoing speech
      this.stop();
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = settings.speechRate;
      
      // Find and set voice
      const voices = this.getVoices();
      const selectedVoice = voices.find(v => v.name === settings.speechVoice);
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      utterance.onend = () => {
        this.currentUtterance = null;
        resolve();
      };
      
      utterance.onerror = (error) => {
        this.currentUtterance = null;
        reject(error);
      };
      
      this.currentUtterance = utterance;
      this.synthesis.speak(utterance);
    });
  }
  
  static stop(): void {
    if (this.synthesis?.speaking) {
      this.synthesis.cancel();
    }
    this.currentUtterance = null;
  }
  
  static pause(): void {
    if (this.synthesis?.speaking && !this.synthesis.paused) {
      this.synthesis.pause();
    }
  }
  
  static resume(): void {
    if (this.synthesis?.paused) {
      this.synthesis.resume();
    }
  }
  
  static isSpeaking(): boolean {
    return this.synthesis?.speaking || false;
  }
}

// ==================== Context & State Management ====================
interface FlashCardsContextType {
  state: AppState;
  addCard: (card: Omit<Card, 'id' | 'created' | 'lastStudied' | 'nextReview' | 'timesStudied' | 'timesCorrect' | 'easeFactor' | 'interval' | 'repetitions' | 'lapses'>) => void;
  updateCard: (id: string, updates: Partial<Card>) => void;
  deleteCard: (id: string) => void;
  importCards: (cards: Card[]) => void;
  updateStudyProgress: (cardId: string, quality: number) => void;
  addStudySession: (session: Omit<StudySession, 'id'>) => void;
  updateSettings: (settings: Partial<AppState['settings']>) => void;
  toggleTheme: () => void;
}

const FlashCardsContext = createContext<FlashCardsContextType | null>(null);

const useFlashCards = () => {
  const context = useContext(FlashCardsContext);
  if (!context) throw new Error('useFlashCards must be used within FlashCardsProvider');
  return context;
};

// ==================== Storage Service ====================
class StorageService {
  private static readonly STORAGE_KEY = 'flashcards-pro-enhanced';
  
  static save(state: AppState): void {
    try {
      const data = {
        ...state,
        categories: Array.from(state.categories),
      };
      // Using in-memory storage for Claude artifacts
      (window as any).__flashcards_data = data;
    } catch (error) {
      console.error('Failed to save data:', error);
    }
  }
  
  static load(): Partial<AppState> | null {
    try {
      const data = (window as any).__flashcards_data;
      if (!data) return null;
      
      return {
        ...data,
        categories: new Set(data.categories || []),
      };
    } catch (error) {
      console.error('Failed to load data:', error);
      return null;
    }
  }
  
  static async exportData(state: AppState): Promise<void> {
    const data = {
      version: '3.0',
      exported: new Date().toISOString(),
      ...state,
      categories: Array.from(state.categories),
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `flashcards-pro-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }
  
  static async importData(file: File): Promise<Partial<AppState>> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target?.result as string);
          resolve({
            ...data,
            categories: new Set(data.categories || []),
          });
        } catch (error) {
          reject(error);
        }
      };
      reader.readAsText(file);
    });
  }
}

// ==================== Mobile Touch Gestures ====================
const useTouchGestures = (onSwipeLeft?: () => void, onSwipeRight?: () => void, onDoubleTap?: () => void) => {
  const [touchStart, setTouchStart] = useState<{x: number, y: number, time: number} | null>(null);
  const [lastTap, setLastTap] = useState<number>(0);
  
  const handleTouchStart = useCallback((e: React.TouchEvent) => {
    const touch = e.touches[0];
    setTouchStart({
      x: touch.clientX,
      y: touch.clientY,
      time: Date.now()
    });
  }, []);
  
  const handleTouchEnd = useCallback((e: React.TouchEvent) => {
    if (!touchStart) return;
    
    const touch = e.changedTouches[0];
    const deltaX = touchStart.x - touch.clientX;
    const deltaY = touchStart.y - touch.clientY;
    const deltaTime = Date.now() - touchStart.time;
    
    // Check for double tap
    if (Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10 && deltaTime < 300) {
      const now = Date.now();
      if (now - lastTap < 300 && onDoubleTap) {
        onDoubleTap();
      }
      setLastTap(now);
    }
    
    // Check for swipe (minimum distance and not too vertical)
    if (Math.abs(deltaX) > 50 && Math.abs(deltaY) < 100 && deltaTime < 500) {
      if (deltaX > 0 && onSwipeLeft) {
        onSwipeLeft();
      } else if (deltaX < 0 && onSwipeRight) {
        onSwipeRight();
      }
    }
    
    setTouchStart(null);
  }, [touchStart, lastTap, onSwipeLeft, onSwipeRight, onDoubleTap]);
  
  return { handleTouchStart, handleTouchEnd };
};

// ==================== Mobile-Optimized Components ====================

// Mobile Card Item Component
interface MobileCardItemProps {
  card: Card;
  onEdit: () => void;
  onDelete: () => void;
  onStudy: () => void;
}

function MobileCardItem({ card, onEdit, onDelete, onStudy }: MobileCardItemProps) {
  const { state: { theme, settings } } = useFlashCards();
  const [showActions, setShowActions] = useState(false);
  
  return (
    <div className={`relative mb-3 rounded-xl border transition-all ${
      theme === 'dark' 
        ? 'bg-gray-800 border-gray-700' 
        : 'bg-white border-gray-200'
    }`}>
      <div className="p-4" onClick={() => setShowActions(!showActions)}>
        <div className="flex justify-between items-start mb-2">
          <h4 className="font-medium text-base leading-tight pr-2 flex-1">{card.question}</h4>
          <span className={`text-xs px-2 py-1 rounded flex-shrink-0 ${
            card.difficulty === 'easy' 
              ? 'bg-green-500 text-white'
              : card.difficulty === 'medium'
              ? 'bg-yellow-500 text-white'
              : 'bg-red-500 text-white'
          }`}>
            {card.difficulty}
          </span>
        </div>
        
        <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mb-3 line-clamp-2`}>
          {card.answer}
        </p>
        
        <div className="flex flex-wrap gap-1">
          {card.category && (
            <span className={`text-xs px-2 py-1 rounded ${
              theme === 'dark' ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'
            }`}>
              {card.category}
            </span>
          )}
          {card.tags.slice(0, 2).map(tag => (
            <span key={tag} className={`text-xs px-2 py-1 rounded ${
              theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'
            }`}>
              {tag}
            </span>
          ))}
          {card.tags.length > 2 && (
            <span className={`text-xs px-2 py-1 rounded ${
              theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'
            }`}>
              +{card.tags.length - 2}
            </span>
          )}
        </div>
      </div>
      
      {/* Action buttons - slide up from bottom */}
      <div className={`overflow-hidden transition-all duration-300 ${
        showActions ? 'max-h-16' : 'max-h-0'
      }`}>
        <div className={`flex border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
          <button
            onClick={(e) => {
              e.stopPropagation();
              onStudy();
            }}
            className={`flex-1 py-3 px-4 text-sm font-medium ${
              theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-50'
            } border-r ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} text-blue-500`}
          >
            Study
          </button>
          <button
            onClick={(e) => {
              e.stopPropagation();
              onEdit();
            }}
            className={`flex-1 py-3 px-4 text-sm font-medium ${
              theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-50'
            } border-r ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}
          >
            Edit
          </button>
          <button
            onClick={(e) => {
              e.stopPropagation();
              onDelete();
            }}
            className={`flex-1 py-3 px-4 text-sm font-medium ${
              theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-50'
            } text-red-500`}
          >
            Delete
          </button>
        </div>
      </div>
    </div>
  );
}

// Mobile Study Card Component
interface MobileStudyCardProps {
  card: Card;
  isFlipped: boolean;
  onFlip: () => void;
  showAnswer?: boolean;
}

function MobileStudyCard({ card, isFlipped, onFlip, showAnswer = false }: MobileStudyCardProps) {
  const { state: { theme, settings } } = useFlashCards();
  const touchGestures = useTouchGestures(
    undefined, // swipe left
    undefined, // swipe right
    onFlip // double tap to flip
  );
  
  return (
    <div 
      className="relative w-full h-80 perspective-1000"
      {...touchGestures}
    >
      <div
        className={`relative w-full h-full transition-transform duration-500 transform-style-preserve-3d cursor-pointer ${
          isFlipped || showAnswer ? 'rotate-y-180' : ''
        }`}
        onClick={onFlip}
      >
        {/* Front - Question */}
        <div className={`absolute inset-0 backface-hidden rounded-2xl p-6 flex flex-col ${
          theme === 'dark' 
            ? 'bg-gradient-to-br from-gray-800 to-gray-900 text-white' 
            : 'bg-gradient-to-br from-white to-gray-100'
        } shadow-xl border ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
          
          <div className="flex justify-between items-start mb-4">
            <span className={`text-xs px-2 py-1 rounded ${
              card.difficulty === 'easy' 
                ? 'bg-green-500 text-white'
                : card.difficulty === 'medium'
                ? 'bg-yellow-500 text-white'
                : 'bg-red-500 text-white'
            }`}>
              {card.difficulty}
            </span>
            
            {settings.speechEnabled && SpeechService.isSupported() && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  SpeechService.speak(card.question, settings);
                }}
                className={`p-2 rounded-lg ${
                  theme === 'dark' ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                <Volume2 className="w-4 h-4" />
              </button>
            )}
          </div>
          
          <div className="flex-1 flex items-center justify-center p-2">
            <div className="text-center">
              <h2 className="text-lg font-medium mb-4 leading-relaxed">{card.question}</h2>
              {card.media.filter(m => m.type === 'image').map(media => (
                <img
                  key={media.id}
                  src={media.data}
                  alt="Question attachment"
                  className="max-w-full max-h-32 mx-auto rounded-lg mb-4"
                />
              ))}
            </div>
          </div>
          
          <div className="text-center text-xs opacity-60">
            Tap or double-tap to reveal answer
          </div>
        </div>
        
        {/* Back - Answer */}
        <div className={`absolute inset-0 backface-hidden rotate-y-180 rounded-2xl p-6 flex flex-col ${
          theme === 'dark' 
            ? 'bg-gradient-to-br from-blue-900 to-blue-800 text-white' 
            : 'bg-gradient-to-br from-blue-50 to-blue-100'
        } shadow-xl border ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
          
          <div className="flex justify-end mb-4">
            {settings.speechEnabled && SpeechService.isSupported() && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  SpeechService.speak(card.answer, settings);
                }}
                className={`p-2 rounded-lg ${
                  theme === 'dark' ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                <Volume2 className="w-4 h-4" />
              </button>
            )}
          </div>
          
          <div className="flex-1 flex items-center justify-center p-2">
            <div className="text-center">
              <h2 className="text-lg font-medium leading-relaxed">{card.answer}</h2>
            </div>
          </div>
          
          <div className="text-center text-xs opacity-60">
            Tap to show question
          </div>
        </div>
      </div>
    </div>
  );
}

// Mobile Study Mode Component
interface MobileStudyModeProps {
  cards: Card[];
  mode: StudyMode;
  onComplete: (results: { correct: number; incorrect: number; duration: number }) => void;
}

function MobileStudyMode({ cards: initialCards, mode, onComplete }: MobileStudyModeProps) {
  const { updateStudyProgress, state: { theme, settings } } = useFlashCards();
  const [cards, setCards] = useState(() => {
    const algorithm = new SpacedRepetitionAlgorithm();
    if (mode === 'spaced') {
      return algorithm.getCardsForReview(initialCards);
    }
    return [...initialCards].sort(() => Math.random() - 0.5);
  });
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);
  const [results, setResults] = useState({ correct: 0, incorrect: 0 });
  const [startTime] = useState(Date.now());
  const [timeRemaining, setTimeRemaining] = useState(mode === 'timed' ? 300 : 0);
  const [quizOptions, setQuizOptions] = useState<string[]>([]);
  const [selectedOption, setSelectedOption] = useState<number | null>(null);
  const [showCompletePrompt, setShowCompletePrompt] = useState(false);
  
  const currentCard = cards[currentIndex];
  const progress = ((currentIndex + 1) / cards.length) * 100;
  
  // Timer for timed mode
  useEffect(() => {
    if (mode === 'timed' && timeRemaining > 0) {
      const timer = setInterval(() => {
        setTimeRemaining(prev => {
          if (prev <= 1) {
            handleComplete();
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
      
      return () => clearInterval(timer);
    }
  }, [mode, timeRemaining]);
  
  // Generate quiz options
  useEffect(() => {
    if (mode === 'quiz' && currentCard) {
      const wrongAnswers = cards
        .filter(c => c.id !== currentCard.id)
        .map(c => c.answer)
        .sort(() => Math.random() - 0.5)
        .slice(0, 3);
      setQuizOptions([currentCard.answer, ...wrongAnswers].sort(() => Math.random() - 0.5));
      setSelectedOption(null);
    }
  }, [mode, currentCard, cards]);
  
  const handleComplete = () => {
    const duration = Math.floor((Date.now() - startTime) / 1000);
    onComplete({ ...results, duration });
  };
  
  const handleResponse = (quality: number) => {
    if (!currentCard) return;
    
    updateStudyProgress(currentCard.id, quality);
    
    if (quality >= 3) {
      setResults(prev => ({ ...prev, correct: prev.correct + 1 }));
    } else {
      setResults(prev => ({ ...prev, incorrect: prev.incorrect + 1 }));
    }
    
    if (currentIndex < cards.length - 1) {
      setTimeout(() => {
        setCurrentIndex(prev => prev + 1);
        setIsFlipped(false);
      }, settings.autoAdvance ? 800 : 0);
    } else {
      setShowCompletePrompt(true);
    }
  };
  
  const handleQuizAnswer = (optionIndex: number) => {
    setSelectedOption(optionIndex);
    const isCorrect = quizOptions[optionIndex] === currentCard.answer;
    
    setTimeout(() => {
      handleResponse(isCorrect ? 4 : 1);
    }, 1200);
  };
  
  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };
  
  const swipeGestures = useTouchGestures(
    () => {
      // Swipe left - next card (if answer shown)
      if (isFlipped && currentIndex < cards.length - 1) {
        setCurrentIndex(prev => prev + 1);
        setIsFlipped(false);
      }
    },
    () => {
      // Swipe right - previous card
      if (currentIndex > 0) {
        setCurrentIndex(prev => prev - 1);
        setIsFlipped(false);
      }
    }
  );
  
  if (!currentCard) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <BookOpen className="w-16 h-16 mx-auto mb-4 text-gray-400" />
          <p className="text-lg">No cards to study</p>
        </div>
      </div>
    );
  }
  
  return (
    <div className="space-y-4 pb-6" {...swipeGestures}>
      {/* Header with progress */}
      <div className="sticky top-0 z-10 bg-opacity-90 backdrop-blur-sm p-4 rounded-xl">
        <div className="flex justify-between items-center mb-2">
          <span className="text-sm font-medium">
            {currentIndex + 1} / {cards.length}
          </span>
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-1">
              <Check className="w-4 h-4 text-green-500" />
              <span className="text-sm">{results.correct}</span>
            </div>
            <div className="flex items-center gap-1">
              <X className="w-4 h-4 text-red-500" />
              <span className="text-sm">{results.incorrect}</span>
            </div>
            {mode === 'timed' && (
              <div className="flex items-center gap-1">
                <Clock className="w-4 h-4" />
                <span className={`text-sm ${timeRemaining < 60 ? 'text-red-500' : ''}`}>
                  {formatTime(timeRemaining)}
                </span>
              </div>
            )}
          </div>
        </div>
        <div className={`h-2 rounded-full overflow-hidden ${
          theme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'
        }`}>
          <div
            className="h-full bg-blue-500 transition-all duration-500"
            style={{ width: `${progress}%` }}
          />
        </div>
      </div>
      
      {/* Study Card */}
      <div className="px-4">
        <MobileStudyCard
          card={currentCard}
          isFlipped={isFlipped}
          onFlip={() => mode !== 'quiz' && setIsFlipped(!isFlipped)}
          showAnswer={mode === 'quiz' && selectedOption !== null}
        />
      </div>
      
      {/* Quiz Options */}
      {mode === 'quiz' && (
        <div className="px-4 space-y-3">
          {quizOptions.map((option, index) => (
            <button
              key={index}
              onClick={() => !selectedOption && handleQuizAnswer(index)}
              disabled={selectedOption !== null}
              className={`w-full p-4 rounded-xl text-left transition-all ${
                selectedOption === null
                  ? theme === 'dark'
                    ? 'bg-gray-800 hover:bg-gray-700 border border-gray-700'
                    : 'bg-white hover:bg-gray-50 border border-gray-200'
                  : selectedOption === index
                  ? option === currentCard.answer
                    ? 'bg-green-500 text-white border-green-500'
                    : 'bg-red-500 text-white border-red-500'
                  : option === currentCard.answer
                  ? 'bg-green-500 text-white border-green-500'
                  : theme === 'dark'
                  ? 'bg-gray-800 opacity-50 border-gray-700'
                  : 'bg-white opacity-50 border-gray-200'
              } border`}
            >
              <span className="block text-sm font-medium mb-1">
                {String.fromCharCode(65 + index)}
              </span>
              <span className="block text-sm leading-relaxed">{option}</span>
            </button>
          ))}
        </div>
      )}
      
      {/* Controls */}
      {mode !== 'quiz' && (
        <div className="px-4">
          {isFlipped ? (
            <div className="grid grid-cols-2 gap-3">
              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={() => handleResponse(1)}
                  className="py-3 px-2 bg-red-500 text-white rounded-xl hover:bg-red-600 text-sm font-medium"
                >
                  Again
                </button>
                <button
                  onClick={() => handleResponse(3)}
                  className="py-3 px-2 bg-yellow-500 text-white rounded-xl hover:bg-yellow-600 text-sm font-medium"
                >
                  Hard
                </button>
              </div>
              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={() => handleResponse(4)}
                  className="py-3 px-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 text-sm font-medium"
                >
                  Good
                </button>
                <button
                  onClick={() => handleResponse(5)}
                  className="py-3 px-2 bg-green-500 text-white rounded-xl hover:bg-green-600 text-sm font-medium"
                >
                  Easy
                </button>
              </div>
            </div>
          ) : (
            <button
              onClick={() => setIsFlipped(true)}
              className="w-full py-4 bg-blue-500 text-white rounded-xl hover:bg-blue-600 text-lg font-medium"
            >
              Show Answer
            </button>
          )}
        </div>
      )}
      
      {/* Navigation hints */}
      <div className="px-4 text-center">
        <p className="text-xs opacity-60">
          {mode !== 'quiz' ? 'Swipe ← → to navigate • Double-tap to flip' : 'Select your answer above'}
        </p>
      </div>
      
      {/* Complete Session Prompt */}
      {showCompletePrompt && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className={`w-full max-w-sm rounded-2xl p-6 ${
            theme === 'dark' ? 'bg-gray-900' : 'bg-white'
          }`}>
            <h3 className="text-xl font-semibold mb-4 text-center">Session Complete!</h3>
            <div className="space-y-3 mb-6">
              <div className="flex justify-between">
                <span>Cards studied:</span>
                <span className="font-medium">{results.correct + results.incorrect}</span>
              </div>
              <div className="flex justify-between">
                <span>Correct:</span>
                <span className="font-medium text-green-500">{results.correct}</span>
              </div>
              <div className="flex justify-between">
                <span>Incorrect:</span>
                <span className="font-medium text-red-500">{results.incorrect}</span>
              </div>
              <div className="flex justify-between">
                <span>Accuracy:</span>
                <span className="font-medium">
                  {results.correct + results.incorrect > 0
                    ? Math.round((results.correct / (results.correct + results.incorrect)) * 100)
                    : 0}%
                </span>
              </div>
            </div>
            <button
              onClick={handleComplete}
              className="w-full py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-medium"
            >
              Finish Session
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// Mobile-optimized Card Editor
function MobileCardEditor({ card, onSave, onCancel }: {
  card?: Card;
  onSave: (card: any) => void;
  onCancel: () => void;
}) {
  const { state: { theme, categories } } = useFlashCards();
  const [question, setQuestion] = useState(card?.question || '');
  const [answer, setAnswer] = useState(card?.answer || '');
  const [category, setCategory] = useState(card?.category || '');
  const [tags, setTags] = useState<string[]>(card?.tags || []);
  const [difficulty, setDifficulty] = useState<Card['difficulty']>(card?.difficulty || 'medium');
  const [tagInput, setTagInput] = useState('');
  
  const handleSubmit = () => {
    if (!question.trim() || !answer.trim()) return;
    
    onSave({
      question: question.trim(),
      answer: answer.trim(),
      category: category.trim(),
      tags,
      difficulty,
      media: [],
    });
  };
  
  const addTag = (tag: string) => {
    const trimmedTag = tag.trim();
    if (trimmedTag && !tags.includes(trimmedTag)) {
      setTags([...tags, trimmedTag]);
    }
    setTagInput('');
  };
  
  const removeTag = (tag: string) => {
    setTags(tags.filter(t => t !== tag));
  };
  
  return (
    <div className="space-y-6">
      <div>
        <label className="block text-sm font-medium mb-2">Question</label>
        <textarea
          value={question}
          onChange={(e) => setQuestion(e.target.value)}
          className={`w-full px-4 py-3 rounded-xl border ${
            theme === 'dark' 
              ? 'bg-gray-800 border-gray-700 text-white' 
              : 'bg-white border-gray-300'
          } focus:outline-none focus:ring-2 focus:ring-blue-500 text-base`}
          rows={3}
          placeholder="Enter your question..."
          required
        />
      </div>
      
      <div>
        <label className="block text-sm font-medium mb-2">Answer</label>
        <textarea
          value={answer}
          onChange={(e) => setAnswer(e.target.value)}
          className={`w-full px-4 py-3 rounded-xl border ${
            theme === 'dark' 
              ? 'bg-gray-800 border-gray-700 text-white' 
              : 'bg-white border-gray-300'
          } focus:outline-none focus:ring-2 focus:ring-blue-500 text-base`}
          rows={3}
          placeholder="Enter the answer..."
          required
        />
      </div>
      
      <div>
        <label className="block text-sm font-medium mb-2">Category</label>
        <input
          value={category}
          onChange={(e) => setCategory(e.target.value)}
          className={`w-full px-4 py-3 rounded-xl border ${
            theme === 'dark' 
              ? 'bg-gray-800 border-gray-700 text-white' 
              : 'bg-white border-gray-300'
          } focus:outline-none focus:ring-2 focus:ring-blue-500 text-base`}
          placeholder="Optional category"
        />
      </div>
      
      <div>
        <label className="block text-sm font-medium mb-2">Tags</label>
        <div className="space-y-3">
          <input
            value={tagInput}
            onChange={(e) => setTagInput(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                addTag(tagInput);
              }
            }}
            className={`w-full px-4 py-3 rounded-xl border ${
              theme === 'dark' 
                ? 'bg-gray-800 border-gray-700 text-white' 
                : 'bg-white border-gray-300'
            } focus:outline-none focus:ring-2 focus:ring-blue-500 text-base`}
            placeholder="Add tags (press Enter to add)"
          />
          {tags.length > 0 && (
            <div className="flex flex-wrap gap-2">
              {tags.map(tag => (
                <span key={tag} className={`inline-flex items-center gap-2 px-3 py-2 rounded-full text-sm ${
                  theme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'
                }`}>
                  {tag}
                  <button
                    type="button"
                    onClick={() => removeTag(tag)}
                    className="hover:text-red-500"
                  >
                    <X className="w-3 h-3" />
                  </button>
                </span>
              ))}
            </div>
          )}
        </div>
      </div>
      
      <div>
        <label className="block text-sm font-medium mb-3">Difficulty</label>
        <div className="grid grid-cols-3 gap-3">
          {(['easy', 'medium', 'hard'] as const).map(level => (
            <button
              key={level}
              type="button"
              onClick={() => setDifficulty(level)}
              className={`py-3 rounded-xl border transition-colors text-sm font-medium ${
                difficulty === level
                  ? level === 'easy'
                    ? 'bg-green-500 text-white border-green-500'
                    : level === 'medium'
                    ? 'bg-yellow-500 text-white border-yellow-500'
                    : 'bg-red-500 text-white border-red-500'
                  : theme === 'dark'
                  ? 'border-gray-700 hover:border-gray-600'
                  : 'border-gray-300 hover:border-gray-400'
              }`}
            >
              {level.charAt(0).toUpperCase() + level.slice(1)}
            </button>
          ))}
        </div>
      </div>
      
      <div className="flex gap-3 pt-4">
        <button
          type="button"
          onClick={onCancel}
          className={`flex-1 py-3 rounded-xl border ${
            theme === 'dark' 
              ? 'border-gray-700 hover:bg-gray-800' 
              : 'border-gray-300 hover:bg-gray-100'
          } transition-colors font-medium`}
        >
          Cancel
        </button>
        <button
          type="button"
          onClick={handleSubmit}
          disabled={!question.trim() || !answer.trim()}
          className="flex-1 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
        >
          {card ? 'Update' : 'Create'}
        </button>
      </div>
    </div>
  );
}

// Main App Component with Mobile Navigation
function FlashCardsProvider({ children }: { children: React.ReactNode }) {
  const [state, setState] = useState<AppState>(() => {
    const saved = StorageService.load();
    return {
      cards: saved?.cards || [
        // Sample cards for testing
        {
          id: '1',
          question: 'What is the capital of France?',
          answer: 'Paris',
          category: 'Geography',
          tags: ['capitals', 'europe'],
          difficulty: 'easy',
          media: [],
          created: new Date().toISOString(),
          lastStudied: null,
          nextReview: null,
          timesStudied: 0,
          timesCorrect: 0,
          easeFactor: 2.5,
          interval: 0,
          repetitions: 0,
          lapses: 0,
        },
        {
          id: '2',
          question: 'What is 2 + 2?',
          answer: '4',
          category: 'Math',
          tags: ['basic', 'addition'],
          difficulty: 'easy',
          media: [],
          created: new Date().toISOString(),
          lastStudied: null,
          nextReview: null,
          timesStudied: 0,
          timesCorrect: 0,
          easeFactor: 2.5,
          interval: 0,
          repetitions: 0,
          lapses: 0,
        },
      ],
      categories: saved?.categories || new Set(['Geography', 'Math']),
      studySessions: saved?.studySessions || [],
      cardProgress: saved?.cardProgress || {},
      theme: saved?.theme || 'dark',
      settings: saved?.settings || {
        dailyGoal: 20,
        notificationsEnabled: false,
        soundEnabled: true,
        autoAdvance: true,
        studyReminders: [],
        speechEnabled: true,
        speechRate: 1.0,
        speechVoice: '',
        autoReadQuestion: false,
        autoReadAnswer: false,
      },
    };
  });
  
  // Auto-save
  useEffect(() => {
    StorageService.save(state);
  }, [state]);
  
  // Apply theme
  useEffect(() => {
    document.documentElement.classList.toggle('dark', state.theme === 'dark');
  }, [state.theme]);
  
  const algorithm = new SpacedRepetitionAlgorithm();
  
  const addCard = (card: Omit<Card, 'id' | 'created' | 'lastStudied' | 'nextReview' | 'timesStudied' | 'timesCorrect' | 'easeFactor' | 'interval' | 'repetitions' | 'lapses'>) => {
    const newCard: Card = {
      ...card,
      id: Date.now().toString(),
      created: new Date().toISOString(),
      lastStudied: null,
      nextReview: null,
      timesStudied: 0,
      timesCorrect: 0,
      easeFactor: 2.5,
      interval: 0,
      repetitions: 0,
      lapses: 0,
    };
    
    setState(prev => ({
      ...prev,
      cards: [...prev.cards, newCard],
      categories: new Set([...prev.categories, card.category].filter(Boolean)),
    }));
  };
  
  const updateCard = (id: string, updates: Partial<Card>) => {
    setState(prev => ({
      ...prev,
      cards: prev.cards.map(card => 
        card.id === id ? { ...card, ...updates } : card
      ),
      categories: updates.category 
        ? new Set([...prev.categories, updates.category])
        : prev.categories,
    }));
  };
  
  const deleteCard = (id: string) => {
    setState(prev => ({
      ...prev,
      cards: prev.cards.filter(card => card.id !== id),
    }));
  };
  
  const importCards = (cards: Card[]) => {
    setState(prev => ({
      ...prev,
      cards: [...prev.cards, ...cards],
      categories: new Set([
        ...prev.categories,
        ...cards.map(c => c.category).filter(Boolean),
      ]),
    }));
  };
  
  const updateStudyProgress = (cardId: string, quality: number) => {
    setState(prev => {
      const card = prev.cards.find(c => c.id === cardId);
      if (!card) return prev;
      
      const updatedCard = algorithm.calculateInterval(card, quality);
      const isCorrect = quality >= 3;
      
      const progress = prev.cardProgress[cardId] || { correct: 0, incorrect: 0, mastery: 0 };
      const newProgress = {
        correct: progress.correct + (isCorrect ? 1 : 0),
        incorrect: progress.incorrect + (isCorrect ? 0 : 1),
        mastery: 0,
      };
      
      const total = newProgress.correct + newProgress.incorrect;
      newProgress.mastery = total > 0 ? Math.round((newProgress.correct / total) * 100) : 0;
      
      return {
        ...prev,
        cards: prev.cards.map(c => c.id === cardId ? updatedCard : c),
        cardProgress: {
          ...prev.cardProgress,
          [cardId]: newProgress,
        },
      };
    });
  };
  
  const addStudySession = (session: Omit<StudySession, 'id'>) => {
    setState(prev => ({
      ...prev,
      studySessions: [
        ...prev.studySessions,
        { ...session, id: Date.now().toString() },
      ],
    }));
  };
  
  const updateSettings = (settings: Partial<AppState['settings']>) => {
    setState(prev => ({
      ...prev,
      settings: { ...prev.settings, ...settings },
    }));
  };
  
  const toggleTheme = () => {
    setState(prev => ({
      ...prev,
      theme: prev.theme === 'dark' ? 'light' : 'dark',
    }));
  };
  
  const value: FlashCardsContextType = {
    state,
    addCard,
    updateCard,
    deleteCard,
    importCards,
    updateStudyProgress,
    addStudySession,
    updateSettings,
    toggleTheme,
  };
  
  return (
    <FlashCardsContext.Provider value={value}>
      {children}
    </FlashCardsContext.Provider>
  );
}

// Main App Component
function MobileFlashCardsApp() {
  const { state, toggleTheme, addCard, updateCard, deleteCard, addStudySession } = useFlashCards();
  const { theme, cards, categories } = state;
  
  const [activeView, setActiveView] = useState<'cards' | 'study' | 'analytics'>('cards');
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState<string>('');
  const [showCardEditor, setShowCardEditor] = useState(false);
  const [editingCard, setEditingCard] = useState<Card | undefined>();
  const [studyMode, setStudyMode] = useState<StudyMode>('standard');
  const [isStudying, setIsStudying] = useState(false);
  const [showMenu, setShowMenu] = useState(false);
  
  // Filter cards
  const filteredCards = useMemo(() => {
    return cards.filter(card => {
      const matchesSearch = !searchQuery || 
        card.question.toLowerCase().includes(searchQuery.toLowerCase()) ||
        card.answer.toLowerCase().includes(searchQuery.toLowerCase()) ||
        card.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()));
      
      const matchesCategory = !selectedCategory || card.category === selectedCategory;
      
      return matchesSearch && matchesCategory;
    });
  }, [cards, searchQuery, selectedCategory]);
  
  const handleStudyComplete = (results: { correct: number; incorrect: number; duration: number }) => {
    addStudySession({
      date: new Date().toISOString(),
      duration: results.duration,
      cardsStudied: results.correct + results.incorrect,
      correctCount: results.correct,
      mode: studyMode,
    });
    
    setIsStudying(false);
  };
  
  const startStudyingCard = (card: Card) => {
    // Start studying with just this card
    setIsStudying(true);
    setActiveView('study');
  };
  
  return (
    <div className={`min-h-screen ${theme === 'dark' ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-900'}`}>
      {/* Mobile Header */}
      <header className={`sticky top-0 z-40 ${
        theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'
      } border-b backdrop-blur-md bg-opacity-90`}>
        <div className="px-4 py-3">
          <div className="flex justify-between items-center">
            <h1 className="text-xl font-bold">
              <span className="bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
                Flash Cards Pro
              </span>
            </h1>
            
            <div className="flex items-center gap-2">
              <button
                onClick={toggleTheme}
                className={`p-2 rounded-lg ${
                  theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                }`}
              >
                {theme === 'dark' ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
              </button>
              
              <button
                onClick={() => setShowMenu(!showMenu)}
                className={`p-2 rounded-lg ${
                  theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                }`}
              >
                <Menu className="w-5 h-5" />
              </button>
            </div>
          </div>
          
          {/* Quick search for cards view */}
          {activeView === 'cards' && !isStudying && (
            <div className="mt-3">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search cards..."
                  className={`w-full pl-10 pr-4 py-2 rounded-xl text-base ${
                    theme === 'dark'
                      ? 'bg-gray-700 border-gray-600'
                      : 'bg-gray-100 border-gray-300'
                  } border focus:outline-none focus:ring-2 focus:ring-blue-500`}
                />
              </div>
            </div>
          )}
        </div>
      </header>
      
      {/* Menu Dropdown */}
      {showMenu && (
        <div className="fixed inset-0 z-50" onClick={() => setShowMenu(false)}>
          <div className={`absolute top-16 right-4 w-48 rounded-xl shadow-lg ${
            theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'
          } border overflow-hidden`}>
            <button
              onClick={() => {
                setShowCardEditor(true);
                setShowMenu(false);
              }}
              className={`w-full px-4 py-3 text-left flex items-center gap-3 ${
                theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
              }`}
            >
              <Plus className="w-4 h-4" />
              New Card
            </button>
            <button
              onClick={() => {
                StorageService.exportData(state);
                setShowMenu(false);
              }}
              className={`w-full px-4 py-3 text-left flex items-center gap-3 ${
                theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
              }`}
            >
              <Download className="w-4 h-4" />
              Export Data
            </button>
            <button
              className={`w-full px-4 py-3 text-left flex items-center gap-3 ${
                theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
              }`}
            >
              <Settings className="w-4 h-4" />
              Settings
            </button>
          </div>
        </div>
      )}
      
      {/* Main Content */}
      <main className="px-4 py-4 pb-20">
        {activeView === 'cards' && !isStudying && (
          <div className="space-y-4">
            {/* Category filter */}
            {categories.size > 0 && (
              <div className="flex gap-2 overflow-x-auto pb-2">
                <button
                  onClick={() => setSelectedCategory('')}
                  className={`px-3 py-2 rounded-xl text-sm font-medium whitespace-nowrap ${
                    !selectedCategory
                      ? 'bg-blue-500 text-white'
                      : theme === 'dark'
                      ? 'bg-gray-800 text-gray-300'
                      : 'bg-gray-200 text-gray-700'
                  }`}
                >
                  All
                </button>
                {Array.from(categories).map(cat => (
                  <button
                    key={cat}
                    onClick={() => setSelectedCategory(cat)}
                    className={`px-3 py-2 rounded-xl text-sm font-medium whitespace-nowrap ${
                      selectedCategory === cat
                        ? 'bg-blue-500 text-white'
                        : theme === 'dark'
                        ? 'bg-gray-800 text-gray-300'
                        : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    {cat}
                  </button>
                ))}
              </div>
            )}
            
            {/* Cards list */}
            {filteredCards.length === 0 ? (
              <div className="text-center py-12">
                <BookOpen className="w-16 h-16 mx-auto mb-4 text-gray-400" />
                <p className="text-lg mb-2">No cards found</p>
                <p className="text-gray-500 mb-4">Create your first card to get started!</p>
                <button
                  onClick={() => setShowCardEditor(true)}
                  className="px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-medium"
                >
                  Create Card
                </button>
              </div>
            ) : (
              <div className="space-y-3">
                {filteredCards.map(card => (
                  <MobileCardItem
                    key={card.id}
                    card={card}
                    onEdit={() => {
                      setEditingCard(card);
                      setShowCardEditor(true);
                    }}
                    onDelete={() => {
                      if (confirm('Delete this card?')) {
                        deleteCard(card.id);
                      }
                    }}
                    onStudy={() => startStudyingCard(card)}
                  />
                ))}
              </div>
            )}
          </div>
        )}
        
        {activeView === 'study' && !isStudying && (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold text-center mb-6">Choose Study Mode</h2>
            
            <div className="space-y-4">
              {[
                {
                  mode: 'standard' as StudyMode,
                  title: 'Standard Study',
                  description: 'Classic flashcard study with self-grading',
                  icon: BookOpen,
                  color: 'blue',
                },
                {
                  mode: 'quiz' as StudyMode,
                  title: 'Quiz Mode',
                  description: 'Multiple choice questions for testing',
                  icon: Brain,
                  color: 'purple',
                },
                {
                  mode: 'spaced' as StudyMode,
                  title: 'Spaced Repetition',
                  description: 'Focus on cards that need review',
                  icon: TrendingUp,
                  color: 'green',
                },
                {
                  mode: 'timed' as StudyMode,
                  title: 'Timed Challenge',
                  description: 'Race against the clock (5 minutes)',
                  icon: Zap,
                  color: 'yellow',
                },
              ].map(({ mode, title, description, icon: Icon, color }) => (
                <button
                  key={mode}
                  onClick={() => setStudyMode(mode)}
                  className={`w-full p-4 rounded-xl border-2 text-left transition-all ${
                    studyMode === mode
                      ? `border-${color}-500 ${
                          theme === 'dark' ? 'bg-gray-800' : 'bg-gray-50'
                        }`
                      : theme === 'dark'
                      ? 'border-gray-700 hover:border-gray-600'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <Icon className={`w-6 h-6 text-${color}-500`} />
                    <div>
                      <h3 className="font-semibold">{title}</h3>
                      <p className={`text-sm ${
                        theme === 'dark' ? 'text-gray-400' : 'text-gray-600'
                      }`}>
                        {description}
                      </p>
                    </div>
                  </div>
                </button>
              ))}
            </div>
            
            <button
              onClick={() => setIsStudying(true)}
              disabled={filteredCards.length === 0}
              className="w-full py-4 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-lg font-medium"
            >
              Start Studying ({filteredCards.length} cards)
            </button>
          </div>
        )}
        
        {(activeView === 'study' || activeView === 'cards') && isStudying && (
          <MobileStudyMode
            cards={filteredCards}
            mode={studyMode}
            onComplete={handleStudyComplete}
          />
        )}
        
        {activeView === 'analytics' && (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold text-center">Analytics</h2>
            
            {/* Simple stats for mobile */}
            <div className="grid grid-cols-2 gap-4">
              <div className={`p-4 rounded-xl ${
                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
              } text-center`}>
                <div className="text-2xl font-bold text-blue-500">{cards.length}</div>
                <div className="text-sm text-gray-500">Total Cards</div>
              </div>
              
              <div className={`p-4 rounded-xl ${
                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
              } text-center`}>
                <div className="text-2xl font-bold text-green-500">
                  {cards.filter(c => c.timesCorrect > 0).length}
                </div>
                <div className="text-sm text-gray-500">Studied Cards</div>
              </div>
              
              <div className={`p-4 rounded-xl ${
                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
