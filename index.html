<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1f2937">
    <title>Flash Cards Pro v6.2</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        html, body { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow-x: hidden; 
            font-family: system-ui, -apple-system, sans-serif;
        }
        #root {
            min-height: 100vh;
        }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .line-clamp-2 { 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        button:active { transform: scale(0.98); }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px) translateX(-50%);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateX(-50%);
            }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0,-8px,0);
            }
            70% {
                transform: translate3d(0,-4px,0);
            }
            90% {
                transform: translate3d(0,-2px,0);
            }
        }
        
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes achievement {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        .animate-achievement {
            animation: achievement 0.6s ease-out;
        }
        
        .animate-slide-in {
            animation: slideInFromRight 0.5s ease-out;
        }
        
        @media screen and (max-width: 768px) { 
            input, textarea, select { font-size: 16px !important; } 
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.8);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef, memo } = React;

        // ========================================
        // CONSTANTS & UTILITIES
        // ========================================
        
        const APP_VERSION = '6.2';
        const STORAGE_KEY = 'flashcards-pro-v62';
        
        // Spaced Repetition Algorithm
        const calculateNextReview = (easeFactor, interval, quality) => {
            let newEaseFactor = easeFactor;
            let newInterval = interval;
            
            if (quality >= 2) {
                if (interval === 0) {
                    newInterval = 1;
                } else if (interval === 1) {
                    newInterval = 6;
                } else {
                    newInterval = Math.round(interval * easeFactor);
                }
                
                newEaseFactor = easeFactor + (0.1 - (3 - quality) * (0.08 + (3 - quality) * 0.02));
            } else {
                newInterval = 1;
                newEaseFactor = Math.max(1.3, easeFactor - 0.2);
            }
            
            return {
                newInterval: Math.max(1, newInterval),
                newEaseFactor: Math.max(1.3, Math.min(2.5, newEaseFactor))
            };
        };
        
        // Fuzzy search implementation
        const fuzzyMatch = (text, pattern, threshold = 0.6) => {
            if (!pattern) return true;
            
            const textLower = text.toLowerCase();
            const patternLower = pattern.toLowerCase();
            
            if (textLower.includes(patternLower)) return true;
            
            const distance = levenshteinDistance(textLower, patternLower);
            const similarity = 1 - distance / Math.max(textLower.length, patternLower.length);
            
            return similarity >= threshold;
        };
        
        const levenshteinDistance = (str1, str2) => {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        };
        
        // Achievement definitions
        const ACHIEVEMENTS = [
            { id: 'first_study', title: 'Getting Started', description: 'Complete your first study session', icon: 'üéØ', category: 'study' },
            { id: 'streak_7', title: 'Week Warrior', description: 'Study for 7 days in a row', icon: 'üî•', category: 'streak' },
            { id: 'streak_30', title: 'Month Master', description: 'Study for 30 days in a row', icon: 'üëë', category: 'streak' },
            { id: 'points_100', title: 'Century Club', description: 'Earn 100 total points', icon: 'üíØ', category: 'points' },
            { id: 'points_500', title: 'Point Powerhouse', description: 'Earn 500 total points', icon: '‚ö°', category: 'points' },
            { id: 'perfect_session', title: 'Perfectionist', description: 'Complete a session with 100% accuracy', icon: '‚ú®', category: 'study' },
            { id: 'speed_demon', title: 'Speed Demon', description: 'Complete 20 cards in under 5 minutes', icon: 'üöÄ', category: 'study' },
            { id: 'master_category', title: 'Category Master', description: 'Master all cards in a category', icon: 'üèÜ', category: 'mastery' },
        ];
        
        // Validation helpers
        const validateCard = (card) => {
            if (!card || typeof card !== 'object') return false;
            if (!card.question || typeof card.question !== 'string' || !card.question.trim()) return false;
            if (!card.answer || typeof card.answer !== 'string' || !card.answer.trim()) return false;
            return true;
        };
        
        const validateSettings = (settings) => {
            const defaults = {
                dailyGoal: 20,
                notificationsEnabled: false,
                soundEnabled: true,
                autoAdvance: true,
                studyReminders: [],
                speechEnabled: true,
                speechRate: 1.0,
                speechVoice: '',
                autoReadQuestion: true,
                autoReadAnswer: true,
                spacedRepetitionEnabled: true,
                showAnswerFirst: false,
                fuzzySearchEnabled: true,
            };
            return { ...defaults, ...settings };
        };

        // ========================================
        // SERVICES
        // ========================================

        class SpeechService {
            static currentUtterance = null;
            static isPlaying = false;
            static isSupported = typeof window !== 'undefined' && 'speechSynthesis' in window;
            
            static speak(text, settings = {}) {
                if (!this.isSupported || !settings.speechEnabled || !text?.trim()) return;
                
                try {
                    this.stop();
                    
                    const utterance = new SpeechSynthesisUtterance(text.trim());
                    utterance.rate = Math.max(0.1, Math.min(2.0, settings.speechRate || 1.0));
                    utterance.volume = 0.8;
                    
                    if (settings.speechVoice) {
                        const voices = window.speechSynthesis.getVoices();
                        const selectedVoice = voices.find(voice => voice.name === settings.speechVoice);
                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                        }
                    }
                    
                    this.currentUtterance = utterance;
                    this.isPlaying = true;
                    
                    utterance.onend = () => {
                        this.currentUtterance = null;
                        this.isPlaying = false;
                    };
                    
                    utterance.onerror = (error) => {
                        console.warn('Speech synthesis error:', error);
                        this.currentUtterance = null;
                        this.isPlaying = false;
                    };
                    
                    window.speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Speech service error:', error);
                    this.currentUtterance = null;
                    this.isPlaying = false;
                }
            }
            
            static stop() {
                if (this.isSupported && window.speechSynthesis) {
                    try {
                        window.speechSynthesis.cancel();
                    } catch (error) {
                        console.warn('Error stopping speech:', error);
                    }
                    this.currentUtterance = null;
                    this.isPlaying = false;
                }
            }
            
            static getAvailableVoices() {
                if (!this.isSupported) return [];
                try {
                    return window.speechSynthesis.getVoices();
                } catch (error) {
                    console.warn('Error getting voices:', error);
                    return [];
                }
            }
        }

        class StorageService {
            static STORAGE_KEY = STORAGE_KEY;
            static VERSION = APP_VERSION;
            
            static save(state) {
                try {
                    const data = { 
                        ...state, 
                        categories: Array.from(state.categories),
                        version: this.VERSION,
                        lastSaved: new Date().toISOString()
                    };
                    
                    const serialized = JSON.stringify(data);
                    localStorage.setItem(this.STORAGE_KEY, serialized);
                } catch (error) {
                    console.error('Failed to save data:', error);
                }
            }
            
            static load() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    if (!data) return null;
                    
                    const parsed = JSON.parse(data);
                    if (!parsed || typeof parsed !== 'object') {
                        throw new Error('Invalid stored data format');
                    }
                    
                    parsed.categories = new Set(parsed.categories || []);
                    
                    if (parsed.cards && Array.isArray(parsed.cards)) {
                        parsed.cards = parsed.cards.filter(validateCard);
                    }
                    
                    if (parsed.settings) {
                        parsed.settings = validateSettings(parsed.settings);
                    }
                    
                    return parsed;
                } catch (error) {
                    console.error('Failed to load data:', error);
                    return null;
                }
            }
            
            static generateAnalytics(state) {
                const { studySessions, cards } = state;
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                const dailyStudy = studySessions
                    .filter(session => new Date(session.date) >= thirtyDaysAgo)
                    .reduce((acc, session) => {
                        const date = session.date.split('T')[0];
                        const existing = acc.find(d => d.date === date);
                        if (existing) {
                            existing.cards += session.cardsStudied;
                            existing.points += session.pointsEarned || 0;
                            existing.accuracy = (existing.accuracy + (session.correctCount / session.cardsStudied)) / 2;
                        } else {
                            acc.push({
                                date,
                                cards: session.cardsStudied,
                                points: session.pointsEarned || 0,
                                accuracy: session.correctCount / session.cardsStudied
                            });
                        }
                        return acc;
                    }, [])
                    .sort((a, b) => a.date.localeCompare(b.date));
                
                const categoryPerformance = Array.from(new Set(cards.map(c => c.category)))
                    .map(category => {
                        const categoryCards = cards.filter(c => c.category === category);
                        const totalStudied = categoryCards.reduce((sum, c) => sum + c.timesStudied, 0);
                        const totalCorrect = categoryCards.reduce((sum, c) => sum + c.timesCorrect, 0);
                        
                        return {
                            category,
                            accuracy: totalStudied > 0 ? totalCorrect / totalStudied : 0,
                            totalCards: categoryCards.length
                        };
                    });
                
                const difficultyBreakdown = [1, 2, 3, 4, 5, 6].map(points => {
                    const pointCards = cards.filter(c => c.points === points);
                    return {
                        points,
                        mastered: pointCards.filter(c => c.easeFactor > 2.3 && c.timesStudied >= 3).length,
                        learning: pointCards.filter(c => c.timesStudied > 0 && c.timesStudied < 3).length,
                        new: pointCards.filter(c => c.timesStudied === 0).length
                    };
                });
                
                return {
                    dailyStudy,
                    weeklyProgress: [],
                    categoryPerformance,
                    difficultyBreakdown
                };
            }
            
            static exportData(state) {
                try {
                    const data = {
                        version: this.VERSION,
                        exported: new Date().toISOString(),
                        ...state,
                        categories: Array.from(state.categories),
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `flashcards-v${this.VERSION}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Export failed:', error);
                    alert('Export failed. Please try again.');
                }
            }
            
            static async importData(file, onSuccess, onError) {
                try {
                    if (!file) {
                        throw new Error('No file provided');
                    }
                    
                    const text = await file.text();
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                        if (data.cards && Array.isArray(data.cards)) {
                            data.cards = data.cards.filter(validateCard);
                            if (data.cards.length === 0) {
                                throw new Error('No valid cards found in JSON file');
                            }
                            onSuccess(data);
                            return;
                        }
                    } catch (e) {
                        // Not JSON, try parsing as Q&A text format
                    }
                    
                    const cards = this.parseQAText(text);
                    if (cards.length > 0) {
                        const importData = {
                            cards,
                            categories: new Set(['Theory Questions']),
                            studySessions: [],
                            cardProgress: {},
                        };
                        onSuccess(importData);
                    } else {
                        throw new Error('No valid questions found in file');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    onError(error.message || 'Failed to import file');
                }
            }
            
            static parseQAText(text) {
                if (!text || typeof text !== 'string') return [];
                
                const cards = [];
                const lines = text.split('\n');
                let currentQuestion = '';
                let currentAnswer = '';
                let isAnswer = false;
                let questionNumber = 1;
                let currentPoints = 1;
                
                try {
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        if (line.match(/^Q\d+\)/)) {
                            if (currentQuestion && currentAnswer) {
                                const fullQuestionPoints = currentQuestion.match(/\((\d+)pt\)/);
                                if (fullQuestionPoints) {
                                    currentPoints = parseInt(fullQuestionPoints[1]);
                                }
                                
                                const card = {
                                    id: questionNumber.toString(),
                                    question: currentQuestion.replace(/\(\d+pt\)/, '').trim(),
                                    answer: currentAnswer.trim(),
                                    category: 'Theory Questions',
                                    tags: [],
                                    points: Math.max(1, Math.min(6, currentPoints)),
                                    media: [],
                                    created: new Date().toISOString(),
                                    lastStudied: null,
                                    nextReview: null,
                                    timesStudied: 0,
                                    timesCorrect: 0,
                                    easeFactor: 2.5,
                                    interval: 0,
                                    repetitions: 0,
                                    lapses: 0,
                                    streak: 0,
                                };
                                
                                if (validateCard(card)) {
                                    cards.push(card);
                                }
                                questionNumber++;
                            }
                            
                            currentQuestion = line;
                            currentAnswer = '';
                            isAnswer = false;
                            currentPoints = 1;
                        } else if (line.startsWith('Answer:')) {
                            isAnswer = true;
                            currentAnswer = line.replace('Answer:', '').trim();
                        } else if (line.length > 0) {
                            if (!isAnswer && currentQuestion && !line.match(/^Q\d+\)/)) {
                                const pointsMatch = line.match(/\((\d+)pt\)/);
                                if (pointsMatch || currentQuestion.includes('?') || currentQuestion.includes(' and ')) {
                                    currentQuestion += (currentQuestion ? '\n' : '') + line;
                                } else {
                                    isAnswer = true;
                                    currentAnswer = line;
                                }
                            } else if (isAnswer) {
                                currentAnswer += (currentAnswer ? '\n' : '') + line;
                            } else {
                                currentQuestion += (currentQuestion ? '\n' : '') + line;
                            }
                        }
                    }
                    
                    if (currentQuestion && currentAnswer) {
                        const fullQuestionPoints = currentQuestion.match(/\((\d+)pt\)/);
                        if (fullQuestionPoints) {
                            currentPoints = parseInt(fullQuestionPoints[1]);
                        }
                        
                        const card = {
                            id: questionNumber.toString(),
                            question: currentQuestion.replace(/\(\d+pt\)/, '').trim(),
                            answer: currentAnswer.trim(),
                            category: 'Theory Questions',
                            tags: [],
                            points: Math.max(1, Math.min(6, currentPoints)),
                            media: [],
                            created: new Date().toISOString(),
                            lastStudied: null,
                            nextReview: null,
                            timesStudied: 0,
                            timesCorrect: 0,
                            easeFactor: 2.5,
                            interval: 0,
                            repetitions: 0,
                            lapses: 0,
                            streak: 0,
                        };
                        
                        if (validateCard(card)) {
                            cards.push(card);
                        }
                    }
                } catch (error) {
                    console.error('Error parsing Q&A text:', error);
                }
                
                return cards;
            }
        }

        class AchievementService {
            static checkAchievements(state, newSession) {
                const newAchievements = [];
                const unlockedIds = new Set(state.achievements.map(a => a.id));
                
                ACHIEVEMENTS.forEach(achievement => {
                    if (unlockedIds.has(achievement.id)) return;
                    
                    let unlocked = false;
                    const now = new Date().toISOString();
                    
                    switch (achievement.id) {
                        case 'first_study':
                            unlocked = state.studySessions.length > 0;
                            break;
                        case 'streak_7':
                            unlocked = state.currentStreak >= 7;
                            break;
                        case 'streak_30':
                            unlocked = state.currentStreak >= 30;
                            break;
                        case 'points_100':
                            unlocked = state.totalPointsEarned >= 100;
                            break;
                        case 'points_500':
                            unlocked = state.totalPointsEarned >= 500;
                            break;
                        case 'perfect_session':
                            unlocked = newSession ? (newSession.correctCount === newSession.cardsStudied && newSession.cardsStudied >= 5) : false;
                            break;
                        case 'speed_demon':
                            unlocked = newSession ? (newSession.cardsStudied >= 20 && newSession.duration <= 300) : false;
                            break;
                        case 'master_category':
                            unlocked = Array.from(state.categories).some(category => {
                                const categoryCards = state.cards.filter(c => c.category === category);
                                return categoryCards.length > 0 && categoryCards.every(c => c.easeFactor > 2.3 && c.timesStudied >= 3);
                            });
                            break;
                    }
                    
                    if (unlocked) {
                        newAchievements.push({ ...achievement, unlockedAt: now });
                    }
                });
                
                return newAchievements;
            }
        }

        // ========================================
        // COMPONENTS
        // ========================================
        
        const Icon = memo(({ name, className = "w-5 h-5" }) => {
            const icons = {
                search: "üîç", plus: "‚ûï", moon: "üåô", sun: "‚òÄÔ∏è", menu: "‚ò∞",
                cards: "üé¥", study: "üìö", stats: "üìä", edit: "‚úèÔ∏è", delete: "üóëÔ∏è",
                check: "‚úÖ", x: "‚ùå", clock: "‚è∞", volume: "üîä", brain: "üß†",
                zap: "‚ö°", target: "üéØ", trend: "üìà", points: "üèÜ", error: "‚ö†Ô∏è",
                fire: "üî•", crown: "üëë", rocket: "üöÄ", star: "‚≠ê", trophy: "üèÜ"
            };
            
            return React.createElement('span', {
                className: `inline-block ${className}`,
                style: { fontSize: '1.2em' }
            }, icons[name] || "üìù");
        });

        // Error Boundary
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true };
            }
            
            componentDidCatch(error, errorInfo) {
                console.error('Flash Cards Pro Error:', error, errorInfo);
                this.setState({
                    error: error,
                    errorInfo: errorInfo
                });
            }
            
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4">
                            <div className="max-w-md w-full bg-white dark:bg-gray-800 rounded-xl p-6 text-center">
                                <Icon name="error" className="w-16 h-16 mx-auto mb-4 text-red-500" />
                                <h2 className="text-xl font-bold mb-2 text-gray-900 dark:text-white">
                                    Oops! Something went wrong
                                </h2>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">
                                    Don't worry - your flashcards are safe! Please refresh the page to continue.
                                </p>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="w-full py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-medium"
                                >
                                    Refresh Page
                                </button>
                                <details className="mt-4 text-left">
                                    <summary className="text-sm text-gray-500 cursor-pointer">
                                        Technical Details
                                    </summary>
                                    <pre className="text-xs mt-2 text-red-600 overflow-auto">
                                        {this.state.error && this.state.error.toString()}
                                    </pre>
                                </details>
                            </div>
                        </div>
                    );
                }
                
                return this.props.children;
            }
        }

        // Context
        const FlashCardsContext = createContext(null);
        const useFlashCards = () => {
            const context = useContext(FlashCardsContext);
            if (!context) throw new Error('useFlashCards must be used within FlashCardsProvider');
            return context;
        };

        // Utility functions
        const getPointsColor = (points) => {
            const pointsNum = Number(points) || 1;
            if (pointsNum <= 2) return 'bg-green-500 text-white';
            if (pointsNum <= 4) return 'bg-yellow-500 text-white';
            return 'bg-red-500 text-white';
        };

        const createDefaultCards = () => {
            const rawData = `
Q1)Explain why MUST there be a safe system of work.(3pt)
Answer: It is a LEGAL requirement under the HASWA 1974.

Q2)a) State the legislation and the regulation therein that refers to the stability of cranes and b) Which regulation states the requirement for all lifting operations to be properly planned?(2pt)
Answer: a) LOLER Regulation 4
b) LOLER Regulation 8

Q3) a) State the regulation number for the lifting of persons under LOLER 1998 and b) List FIVE requirements to be within a procedure.(6pt)
Answer: a)LOLER Regulation 5
b) 1. Has suitable devices to prevent the risk of carrier falling
2. A person trapped in any carrier can be freed
3. The carrier has an enhanced safety coefficient suspension rope or chain
4. The rope or chain is inspected by a competent person every working day
5. The use of carrier clearly marked for personnel use

Q4)a) What is the 'Factor of Safety' when lifting personnel and
b) What needs to be taken into account with wind speeds?(1pt)
Answer: a) 2:1
b) maximum wind speeds of 7m/s

Q5)How does the guidance in LOLER 1998 (L 113) describe the difference between installed and positioned?(4pt)
Answer: Installed ‚Äì fixed in location (tower crane)
Positioned ‚Äì manoeuvred in to place (mobile crane)
            `;
            
            return StorageService.parseQAText(rawData);
        };

        // Achievement Notification Component
        const AchievementNotification = memo(({ achievement, onClose }) => {
            const { state: { theme } } = useFlashCards();
            
            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);
            
            return (
                <div className={`fixed top-20 right-4 z-50 max-w-sm rounded-xl p-4 shadow-lg animate-achievement ${
                    theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'
                } border`}>
                    <div className="flex items-start gap-3">
                        <div className="text-2xl animate-bounce">{achievement.icon}</div>
                        <div className="flex-1">
                            <h4 className="font-bold text-sm">Achievement Unlocked!</h4>
                            <p className="font-medium text-sm text-blue-500">{achievement.title}</p>
                            <p className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                {achievement.description}
                            </p>
                        </div>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                            ‚úï
                        </button>
                    </div>
                </div>
            );
        });

        // Analytics Dashboard
        const AnalyticsDashboard = memo(({ analytics }) => {
            const { state: { theme } } = useFlashCards();
            
            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-center mb-6">üìä Analytics Dashboard</h2>
                    
                    <div className={`p-4 rounded-xl ${theme === 'dark' ? 'bg-gray-800' : 'bg-white'}`}>
                        <h3 className="font-semibold mb-3">Daily Study Progress (Last 14 Days)</h3>
                        <div className="h-32 flex items-end gap-1 overflow-x-auto">
                            {analytics.dailyStudy.slice(-14).map((day, index) => (
                                <div key={day.date} className="flex flex-col items-center min-w-8">
                                    <div 
                                        className="w-6 bg-blue-500 rounded-t"
                                        style={{ height: `${Math.max(4, (day.cards / 20) * 100)}px` }}
                                        title={`${day.date}: ${day.cards} cards, ${Math.round(day.accuracy * 100)}% accuracy`}
                                    />
                                    <div className="text-xs mt-1 text-gray-500">
                                        {new Date(day.date).getDate()}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className={`p-4 rounded-xl ${theme === 'dark' ? 'bg-gray-800' : 'bg-white'}`}>
                        <h3 className="font-semibold mb-3">Category Performance</h3>
                        <div className="space-y-2">
                            {analytics.categoryPerformance.map(cat => (
                                <div key={cat.category} className="flex items-center gap-3">
                                    <div className="flex-1 text-sm">{cat.category}</div>
                                    <div className="flex-1">
                                        <div className={`h-2 rounded-full ${theme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                            <div 
                                                className="h-full bg-green-500 rounded-full"
                                                style={{ width: `${cat.accuracy * 100}%` }}
                                            />
                                        </div>
                                    </div>
                                    <div className="text-xs text-gray-500 w-12 text-right">
                                        {Math.round(cat.accuracy * 100)}%
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className={`p-4 rounded-xl ${theme === 'dark' ? 'bg-gray-800' : 'bg-white'}`}>
                        <h3 className="font-semibold mb-3">Learning Progress by Difficulty</h3>
                        <div className="grid grid-cols-2 gap-3">
                            {analytics.difficultyBreakdown.filter(d => d.mastered + d.learning + d.new > 0).map(diff => (
                                <div key={diff.points} className="text-center">
                                    <div className={`text-xs px-2 py-1 rounded inline-flex items-center gap-1 mb-2 ${getPointsColor(diff.points)}`}>
                                        <Icon name="points" className="w-3 h-3" />
                                        {diff.points}pt
                                    </div>
                                    <div className="space-y-1">
                                        <div className="flex justify-between text-xs">
                                            <span>Mastered</span>
                                            <span className="text-green-500">{diff.mastered}</span>
                                        </div>
                                        <div className="flex justify-between text-xs">
                                            <span>Learning</span>
                                            <span className="text-yellow-500">{diff.learning}</span>
                                        </div>
                                        <div className="flex justify-between text-xs">
                                            <span>New</span>
                                            <span className="text-gray-500">{diff.new}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        });

        // Enhanced Search Component
        const EnhancedSearch = memo(({ searchQuery, onSearchChange, selectedTags, onTagToggle, availableTags, fuzzyEnabled }) => {
            const { state: { theme } } = useFlashCards();
            
            return (
                <div className="space-y-3">
                    <div className="relative">
                        <Icon name="search" className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
                        <input
                            type="text"
                            value={searchQuery}
                            onChange={(e) => onSearchChange(e.target.value)}
                            placeholder={fuzzyEnabled ? "Smart search (typos OK)..." : "Search cards..."}
                            className={`w-full pl-10 pr-4 py-2 rounded-xl text-base ${
                                theme === 'dark'
                                    ? 'bg-gray-700 border-gray-600'
                                    : 'bg-gray-100 border-gray-300'
                            } border focus:outline-none focus:ring-2 focus:ring-blue-500`}
                        />
                        {fuzzyEnabled && (
                            <div className="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-blue-500">
                                ‚ú® Smart
                            </div>
                        )}
                    </div>
                    
                    {availableTags.length > 0 && (
                        <div className="flex gap-2 overflow-x-auto pb-1">
                            {availableTags.map(tag => (
                                <button
                                    key={tag}
                                    onClick={() => onTagToggle(tag)}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap ${
                                        selectedTags.includes(tag)
                                            ? 'bg-blue-500 text-white'
                                            : theme === 'dark'
                                            ? 'bg-gray-800 text-gray-300'
                                            : 'bg-gray-200 text-gray-700'
                                    }`}
                                >
                                    #{tag}
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        });

        // Card Item Component
        const MobileCardItem = memo(({ card, onEdit, onDelete, onStudy }) => {
            const { state: { theme } } = useFlashCards();
            const [showActions, setShowActions] = useState(false);
            
            const handleCardClick = useCallback(() => {
                setShowActions(!showActions);
            }, [showActions]);
            
            const handleEdit = useCallback((e) => {
                e.stopPropagation();
                onEdit();
            }, [onEdit]);
            
            const handleDelete = useCallback((e) => {
                e.stopPropagation();
                onDelete();
            }, [onDelete]);
            
            const handleStudy = useCallback((e) => {
                e.stopPropagation();
                onStudy();
            }, [onStudy]);
            
            const getMasteryColor = () => {
                if (card.timesStudied === 0) return 'bg-gray-500';
                if (card.easeFactor > 2.3 && card.timesStudied >= 3) return 'bg-green-500';
                if (card.timesStudied >= 1) return 'bg-yellow-500';
                return 'bg-red-500';
            };
            
            return (
                <div className={`relative mb-3 rounded-xl border transition-all cursor-pointer ${
                    theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'
                }`}>
                    <div className="p-4" onClick={handleCardClick}>
                        <div className="flex justify-between items-start mb-2">
                            <h4 className="font-medium text-base leading-tight pr-2 flex-1">{card.question}</h4>
                            <div className="flex items-center gap-2 flex-shrink-0">
                                <div 
                                    className={`w-2 h-2 rounded-full ${getMasteryColor()}`}
                                    title={`Studied ${card.timesStudied} times, ${Math.round((card.timesCorrect / Math.max(1, card.timesStudied)) * 100)}% accuracy`}
                                />
                                <span className={`text-xs px-2 py-1 rounded flex items-center gap-1 ${getPointsColor(card.points || 1)}`}>
                                    <Icon name="points" className="w-3 h-3" />
                                    {card.points || 1}pt
                                </span>
                            </div>
                        </div>
                        
                        <p className={`text-sm mb-3 line-clamp-2 ${
                            theme === 'dark' ? 'text-gray-400' : 'text-gray-600'
                        }`}>
                            {card.answer}
                        </p>
                        
                        <div className="flex flex-wrap gap-1">
                            {card.category && (
                                <span className={`text-xs px-2 py-1 rounded ${
                                    theme === 'dark' ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'
                                }`}>
                                    {card.category}
                                </span>
                            )}
                            {card.tags?.slice(0, 2).map(tag => (
                                <span key={tag} className={`text-xs px-2 py-1 rounded ${
                                    theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'
                                }`}>
                                    #{tag}
                                </span>
                            ))}
                            {card.streak > 0 && (
                                <span className="text-xs px-2 py-1 rounded bg-orange-500 text-white flex items-center gap-1">
                                    <Icon name="fire" className="w-3 h-3" />
                                    {card.streak}
                                </span>
                            )}
                        </div>
                    </div>
                    
                    <div className={`overflow-hidden transition-all duration-300 ${
                        showActions ? 'max-h-16' : 'max-h-0'
                    }`}>
                        <div className={`flex border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                            <button
                                onClick={handleStudy}
                                className={`flex-1 py-3 px-4 text-sm font-medium text-blue-500 ${
                                    theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-50'
                                } border-r ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}
                            >
                                Study
                            </button>
                            <button
                                onClick={handleEdit}
                                className={`flex-1 py-3 px-4 text-sm font-medium ${
                                    theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-50'
                                } border-r ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}
                            >
                                Edit
                            </button>
                            <button
                                onClick={handleDelete}
                                className={`flex-1 py-3 px-4 text-sm font-medium text-red-500 ${
                                    theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-50'
                                }`}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            );
        });

        // Card Editor Component
        const MobileCardEditor = memo(({ card, onSave, onCancel }) => {
            const { state: { theme } } = useFlashCards();
            const [question, setQuestion] = useState(card?.question || '');
            const [answer, setAnswer] = useState(card?.answer || '');
            const [category, setCategory] = useState(card?.category || '');
            const [points, setPoints] = useState(card?.points || 1);
            const [tags, setTags] = useState(card?.tags || []);
            const [newTag, setNewTag] = useState('');
            
            const handleSubmit = useCallback(() => {
                if (!question.trim() || !answer.trim()) return;
                
                const cardData = {
                    question: question.trim(),
                    answer: answer.trim(),
                    category: category.trim(),
                    tags: tags.filter(tag => tag.trim().length > 0),
                    points: points,
                    media: [],
                };
                
                if (validateCard(cardData)) {
                    onSave(cardData);
                }
            }, [question, answer, category, points, tags, onSave]);
            
            const addTag = useCallback(() => {
                if (newTag.trim() && !tags.includes(newTag.trim())) {
                    setTags([...tags, newTag.trim()]);
                    setNewTag('');
                }
            }, [newTag, tags]);
            
            const removeTag = useCallback((tagToRemove) => {
                setTags(tags.filter(tag => tag !== tagToRemove));
            }, [tags]);
            
            return (
                <div className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium mb-2">Question</label>
                        <textarea
                            value={question}
                            onChange={(e) => setQuestion(e.target.value)}
                            className={`w-full px-4 py-3 rounded-xl border ${
                                theme === 'dark' 
                                    ? 'bg-gray-800 border-gray-700 text-white' 
                                    : 'bg-white border-gray-300'
                            } focus:outline-none focus:ring-2 focus:ring-blue-500 text-base`}
                            rows={3}
                            placeholder="Enter your question..."
                            required
                        />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium mb-2">Answer</label>
                        <textarea
                            value={answer}
                            onChange={(e) => setAnswer(e.target.value)}
                            className={`w-full px-4 py-3 rounded-xl border ${
                                theme === 'dark' 
                                    ? 'bg-gray-800 border-gray-700 text-white' 
                                    : 'bg-white border-gray-300'
                            } focus:outline-none focus:ring-2 focus:ring-blue-500 text-base`}
                            rows={3}
                            placeholder="Enter the answer..."
                            required
                        />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium mb-2">Category</label>
                        <input
                            value={category}
                            onChange={(e) => setCategory(e.target.value)}
                            className={`w-full px-4 py-3 rounded-xl border ${
                                theme === 'dark' 
                                    ? 'bg-gray-800 border-gray-700 text-white' 
                                    : 'bg-white border-gray-300'
                            } focus:outline-none focus:ring-2 focus:ring-blue-500 text-base`}
                            placeholder="Optional category"
                        />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium mb-2">Tags</label>
                        <div className="flex gap-2 mb-2">
                            <input
                                value={newTag}
                                onChange={(e) => setNewTag(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && addTag()}
                                className={`flex-1 px-4 py-2 rounded-xl border ${
                                    theme === 'dark' 
                                        ? 'bg-gray-800 border-gray-700 text-white' 
                                        : 'bg-white border-gray-300'
                                } focus:outline-none focus:ring-2 focus:ring-blue-500 text-base`}
                                placeholder="Add a tag..."
                            />
                            <button
                                type="button"
                                onClick={addTag}
                                className="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600"
                            >
                                Add
                            </button>
                        </div>
                        
                        {tags.length > 0 && (
                            <div className="flex flex-wrap gap-2">
                                {tags.map(tag => (
                                    <span
                                        key={tag}
                                        className={`inline-flex items-center gap-1 px-3 py-1 rounded-lg text-sm ${
                                            theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'
                                        }`}
                                    >
                                        #{tag}
                                        <button
                                            type="button"
                                            onClick={() => removeTag(tag)}
                                            className="text-red-500 hover:text-red-700"
                                        >
                                            ‚úï
                                        </button>
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium mb-3">Points</label>
                        <div className="grid grid-cols-6 gap-2">
                            {[1, 2, 3, 4, 5, 6].map(pt => (
                                <button
                                    key={pt}
                                    type="button"
                                    onClick={() => setPoints(pt)}
                                    className={`py-3 rounded-xl border transition-colors text-sm font-medium ${
                                        points === pt
                                            ? getPointsColor(pt) + ' border-transparent'
                                            : theme === 'dark'
                                            ? 'border-gray-700 hover:border-gray-600'
                                            : 'border-gray-300 hover:border-gray-400'
                                    }`}
                                >
                                    {pt}pt
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="flex gap-3 pt-4">
                        <button
                            type="button"
                            onClick={onCancel}
                            className={`flex-1 py-3 rounded-xl border ${
                                theme === 'dark' 
                                    ? 'border-gray-700 hover:bg-gray-800' 
                                    : 'border-gray-300 hover:bg-gray-100'
                            } transition-colors font-medium`}
                        >
                            Cancel
                        </button>
                        <button
                            type="button"
                            onClick={handleSubmit}
                            disabled={!question.trim() || !answer.trim()}
                            className="flex-1 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
                        >
                            {card ? 'Update' : 'Create'}
                        </button>
                    </div>
                </div>
            );
        });

        // Spaced Repetition Study Mode Component
        const SpacedRepetitionStudyMode = memo(({ cards, onComplete }) => {
            const { state: { theme, settings }, updateCardProgress } = useFlashCards();
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [startTime] = useState(Date.now());
            const [results, setResults] = useState([]);
            
            const sortedCards = useMemo(() => {
                const now = new Date();
                return [...cards].sort((a, b) => {
                    const aReview = a.nextReview ? new Date(a.nextReview) : now;
                    const bReview = b.nextReview ? new Date(b.nextReview) : now;
                    return aReview.getTime() - bReview.getTime();
                });
            }, [cards]);
            
            const currentCard = sortedCards[currentIndex];
            
            const handleDifficultyResponse = useCallback((difficulty) => {
                const timeSpent = Date.now() - startTime;
                const quality = { again: 0, hard: 1, medium: 2, easy: 3 }[difficulty];
                
                const result = {
                    cardId: currentCard.id,
                    correct: quality >= 2,
                    timeSpent,
                    difficulty
                };
                
                setResults(prev => [...prev, result]);
                updateCardProgress(currentCard.id, result);
                
                if (currentIndex < sortedCards.length - 1) {
                    setCurrentIndex(currentIndex + 1);
                    setIsFlipped(false);
                } else {
                    const duration = Math.floor((Date.now() - startTime) / 1000);
                    const correct = results.filter(r => r.correct).length + (quality >= 2 ? 1 : 0);
                    onComplete({
                        correct,
                        incorrect: results.length + 1 - correct,
                        duration,
                        mode: 'spaced-repetition'
                    });
                }
            }, [currentCard, currentIndex, sortedCards.length, results, updateCardProgress, startTime, onComplete]);
            
            if (!currentCard) {
                return (
                    <div className="text-center py-12">
                        <Icon name="check" className="w-16 h-16 mx-auto mb-4 text-green-500" />
                        <h2 className="text-xl font-bold mb-2">All caught up!</h2>
                        <p className="text-gray-500">No cards due for review right now.</p>
                    </div>
                );
            }
            
            const cleanQuestion = currentCard.question.replace(/^Q\d+\)\s*/, '');
            
            return (
                <div className="space-y-4">
                    <div className="p-4 rounded-xl">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-medium">
                                Card {currentIndex + 1} of {sortedCards.length}
                            </span>
                            <span className="text-xs text-blue-500">Smart Review</span>
                        </div>
                        <div className={`h-2 rounded-full overflow-hidden ${
                            theme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'
                        }`}>
                            <div
                                className="h-full bg-blue-500 transition-all duration-500"
                                style={{ width: `${((currentIndex + 1) / sortedCards.length) * 100}%` }}
                            />
                        </div>
                    </div>
                    
                    <div className="px-4">
                        <div 
                            className={`relative w-full h-96 perspective-1000 cursor-pointer`}
                            onClick={() => setIsFlipped(!isFlipped)}
                        >
                            <div className={`relative w-full h-full transition-transform duration-500 transform-style-preserve-3d ${
                                isFlipped ? 'rotate-y-180' : ''
                            }`}>
                                <div className={`absolute inset-0 backface-hidden rounded-2xl p-8 flex flex-col justify-center ${
                                    theme === 'dark' 
                                        ? 'bg-gradient-to-br from-gray-800 to-gray-900 text-white' 
                                        : 'bg-gradient-to-br from-white to-gray-100'
                                } shadow-xl border ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <div className="text-center">
                                        <h2 className="text-lg font-medium leading-relaxed">{cleanQuestion}</h2>
                                    </div>
                                    <div className="text-center text-sm opacity-70 mt-6">
                                        Tap to reveal answer
                                    </div>
                                </div>
                                
                                <div className={`absolute inset-0 backface-hidden rotate-y-180 rounded-2xl p-8 flex flex-col justify-center ${
                                    theme === 'dark' 
                                        ? 'bg-gradient-to-br from-blue-900 to-blue-800 text-white' 
                                        : 'bg-gradient-to-br from-blue-50 to-blue-100'
                                } shadow-xl border ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <div className="text-center">
                                        <h2 className="text-lg font-medium leading-relaxed whitespace-pre-line">{currentCard.answer}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {isFlipped && (
                        <div className="px-4 animate-slide-in">
                            <p className="text-center text-sm mb-4 opacity-70">How well did you know this?</p>
                            <div className="grid grid-cols-2 gap-3">
                                <button
                                    onClick={() => handleDifficultyResponse('again')}
                                    className="py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 font-medium"
                                >
                                    Again (&lt;1m)
                                </button>
                                <button
                                    onClick={() => handleDifficultyResponse('hard')}
                                    className="py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 font-medium"
                                >
                                    Hard (6m)
                                </button>
                                <button
                                    onClick={() => handleDifficultyResponse('medium')}
                                    className="py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-medium"
                                >
                                    Good (10m)
                                </button>
                                <button
                                    onClick={() => handleDifficultyResponse('easy')}
                                    className="py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 font-medium"
                                >
                                    Easy (4d)
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        // Standard Study Mode (Simplified from previous version)
        const StandardStudyMode = memo(({ cards, onComplete }) => {
            const { state: { theme } } = useFlashCards();
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [startTime] = useState(Date.now());
            
            const currentCard = cards[currentIndex];
            const progress = ((currentIndex + 1) / cards.length) * 100;
            
            const totalPoints = useMemo(() => {
                return cards.reduce((sum, card) => sum + (card.points || 1), 0);
            }, [cards]);
            
            const handleNext = useCallback(() => {
                if (currentIndex < cards.length - 1) {
                    setCurrentIndex(currentIndex + 1);
                    setIsFlipped(false);
                } else {
                    const duration = Math.floor((Date.now() - startTime) / 1000);
                    onComplete({ 
                        correct: cards.length,
                        incorrect: 0, 
                        duration,
                        mode: 'standard'
                    });
                }
            }, [currentIndex, cards.length, startTime, onComplete]);
            
            if (!currentCard) {
                return (
                    <div className="flex items-center justify-center h-96">
                        <div className="text-center">
                            <Icon name="study" className="w-16 h-16 mx-auto mb-4 text-gray-400" />
                            <p className="text-lg">No cards to study</p>
                        </div>
                    </div>
                );
            }
            
            const cleanQuestion = currentCard.question.replace(/^Q\d+\)\s*/, '');
            
            return (
                <div className="space-y-4 pb-6">
                    <div className="p-4 rounded-xl">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-medium">
                                Question {currentIndex + 1} of {cards.length}
                            </span>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-1">
                                    <Icon name="points" className="w-4 h-4 text-blue-500" />
                                    <span className="text-sm font-medium">{totalPoints}pt total</span>
                                </div>
                            </div>
                        </div>
                        <div className={`h-2 rounded-full overflow-hidden ${
                            theme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'
                        }`}>
                            <div
                                className="h-full bg-blue-500 transition-all duration-500"
                                style={{ width: `${progress}%` }}
                            />
                        </div>
                    </div>
                    
                    <div className="px-4">
                        <div 
                            className={`relative w-full h-96 perspective-1000 cursor-pointer`}
                            onClick={() => setIsFlipped(!isFlipped)}
                        >
                            <div className={`relative w-full h-full transition-transform duration-500 transform-style-preserve-3d ${
                                isFlipped ? 'rotate-y-180' : ''
                            }`}>
                                <div className={`absolute inset-0 backface-hidden rounded-2xl p-8 flex flex-col justify-center ${
                                    theme === 'dark' 
                                        ? 'bg-gradient-to-br from-gray-800 to-gray-900 text-white' 
                                        : 'bg-gradient-to-br from-white to-gray-100'
                                } shadow-xl border ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <div className="text-center">
                                        <h2 className="text-lg font-medium leading-relaxed">{cleanQuestion}</h2>
                                    </div>
                                    <div className="text-center text-sm opacity-70 mt-6">
                                        Tap to reveal answer
                                    </div>
                                </div>
                                
                                <div className={`absolute inset-0 backface-hidden rotate-y-180 rounded-2xl p-8 flex flex-col justify-center ${
                                    theme === 'dark' 
                                        ? 'bg-gradient-to-br from-blue-900 to-blue-800 text-white' 
                                        : 'bg-gradient-to-br from-blue-50 to-blue-100'
                                } shadow-xl border ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <div className="text-center">
                                        <h2 className="text-lg font-medium leading-relaxed whitespace-pre-line">{currentCard.answer}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="px-4">
                        <div className="grid grid-cols-2 gap-3">
                            <button
                                onClick={() => {
                                    if (currentIndex > 0) {
                                        setCurrentIndex(currentIndex - 1);
                                        setIsFlipped(false);
                                    }
                                }}
                                disabled={currentIndex === 0}
                                className={`py-3 rounded-xl border font-medium transition-all ${
                                    currentIndex === 0
                                        ? 'opacity-50 cursor-not-allowed'
                                        : theme === 'dark'
                                        ? 'border-gray-700 hover:bg-gray-800'
                                        : 'border-gray-300 hover:bg-gray-100'
                                }`}
                            >
                                ‚Üê Previous
                            </button>
                            <button
                                onClick={handleNext}
                                className="py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-medium transition-all"
                            >
                                {currentIndex === cards.length - 1 ? 'Complete' : 'Next ‚Üí'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        });

        // Provider Component
        function FlashCardsProvider({ children }) {
            const [state, setState] = useState(() => {
                const saved = StorageService.load();
                if (saved?.cards) {
                    saved.cards = saved.cards.map(card => ({
                        ...card,
                        points: card.points || 1,
                        streak: card.streak || 0,
                        tags: card.tags || [],
                    }));
                }
                return {
                    cards: saved?.cards || createDefaultCards(),
                    categories: saved?.categories || new Set(['Theory Questions']),
                    studySessions: saved?.studySessions || [],
                    cardProgress: saved?.cardProgress || {},
                    theme: saved?.theme || 'dark',
                    settings: validateSettings(saved?.settings || {}),
                    currentStreak: saved?.currentStreak || 0,
                    longestStreak: saved?.longestStreak || 0,
                    totalPointsEarned: saved?.totalPointsEarned || 0,
                    achievements: saved?.achievements || [],
                    lastStudyDate: saved?.lastStudyDate || null,
                };
            });
            
            const [achievementNotification, setAchievementNotification] = useState(null);
            
            useEffect(() => {
                StorageService.save(state);
            }, [state]);
            
            useEffect(() => {
                document.documentElement.classList.toggle('dark', state.theme === 'dark');
            }, [state.theme]);
            
            const addCard = useCallback((card) => {
                if (!validateCard(card)) {
                    console.error('Invalid card data:', card);
                    return;
                }
                
                const newCard = {
                    ...card,
                    id: Date.now().toString(),
                    created: new Date().toISOString(),
                    lastStudied: null,
                    nextReview: null,
                    timesStudied: 0,
                    timesCorrect: 0,
                    easeFactor: 2.5,
                    interval: 0,
                    repetitions: 0,
                    lapses: 0,
                    streak: 0,
                };
                
                setState(prev => ({
                    ...prev,
                    cards: [...prev.cards, newCard],
                    categories: new Set([...prev.categories, card.category].filter(Boolean)),
                }));
            }, []);
            
            const updateCard = useCallback((id, updates) => {
                setState(prev => ({
                    ...prev,
                    cards: prev.cards.map(card => 
                        card.id === id ? { ...card, ...updates } : card
                    ),
                    categories: updates.category 
                        ? new Set([...prev.categories, updates.category])
                        : prev.categories,
                }));
            }, []);
            
            const deleteCard = useCallback((id) => {
                setState(prev => ({
                    ...prev,
                    cards: prev.cards.filter(card => card.id !== id),
                }));
            }, []);
            
            const addStudySession = useCallback((session) => {
                const newSession = { ...session, id: Date.now().toString() };
                
                setState(prev => {
                    const today = new Date().toISOString().split('T')[0];
                    const lastStudy = prev.lastStudyDate ? new Date(prev.lastStudyDate).toISOString().split('T')[0] : null;
                    
                    let newStreak = prev.currentStreak;
                    if (lastStudy === today) {
                        // Already studied today
                    } else if (lastStudy === new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0]) {
                        newStreak += 1;
                    } else {
                        newStreak = 1;
                    }
                    
                    const newTotalPoints = prev.totalPointsEarned + (session.pointsEarned || 0);
                    const newState = {
                        ...prev,
                        studySessions: [...prev.studySessions, newSession],
                        currentStreak: newStreak,
                        longestStreak: Math.max(prev.longestStreak, newStreak),
                        totalPointsEarned: newTotalPoints,
                        lastStudyDate: new Date().toISOString(),
                    };
                    
                    const newAchievements = AchievementService.checkAchievements(newState, newSession);
                    if (newAchievements.length > 0) {
                        setAchievementNotification(newAchievements[0]);
                        newState.achievements = [...prev.achievements, ...newAchievements];
                    }
                    
                    return newState;
                });
            }, []);
            
            const updateCardProgress = useCallback((cardId, result) => {
                setState(prev => ({
                    ...prev,
                    cards: prev.cards.map(card => {
                        if (card.id !== cardId) return card;
                        
                        const quality = { again: 0, hard: 1, medium: 2, easy: 3 }[result.difficulty];
                        const { newInterval, newEaseFactor } = calculateNextReview(card.easeFactor, card.interval, quality);
                        
                        const nextReview = new Date();
                        nextReview.setDate(nextReview.getDate() + newInterval);
                        
                        return {
                            ...card,
                            lastStudied: new Date().toISOString(),
                            nextReview: nextReview.toISOString(),
                            timesStudied: card.timesStudied + 1,
                            timesCorrect: card.timesCorrect + (result.correct ? 1 : 0),
                            easeFactor: newEaseFactor,
                            interval: newInterval,
                            repetitions: result.correct ? card.repetitions + 1 : 0,
                            lapses: result.correct ? card.lapses : card.lapses + 1,
                            streak: result.correct ? card.streak + 1 : 0,
                        };
                    }),
                }));
            }, []);
            
            const toggleTheme = useCallback(() => {
                setState(prev => ({
                    ...prev,
                    theme: prev.theme === 'dark' ? 'light' : 'dark',
                }));
            }, []);
            
            const importData = useCallback((importedData) => {
                if (!importedData || !Array.isArray(importedData.cards)) {
                    console.error('Invalid import data');
                    return;
                }
                
                const validCards = importedData.cards.filter(validateCard);
                
                setState(prev => ({
                    ...prev,
                    cards: [...prev.cards, ...validCards],
                    categories: new Set([...prev.categories, ...(importedData.categories || [])]),
                }));
            }, []);
            
            const clearAllCards = useCallback(() => {
                setState(prev => ({
                    ...prev,
                    cards: [],
                    categories: new Set(['Theory Questions']),
                    studySessions: [],
                    cardProgress: {},
                }));
            }, []);
            
            const toggleSpeech = useCallback(() => {
                setState(prev => ({
                    ...prev,
                    settings: {
                        ...prev.settings,
                        speechEnabled: !prev.settings.speechEnabled,
                        autoReadQuestion: !prev.settings.speechEnabled,
                        autoReadAnswer: !prev.settings.speechEnabled,
                    }
                }));
                
                if (state.settings.speechEnabled) {
                    SpeechService.stop();
                }
            }, [state.settings.speechEnabled]);
            
            const getAnalytics = useCallback(() => {
                return StorageService.generateAnalytics(state);
            }, [state]);
            
            const value = useMemo(() => ({
                state,
                addCard,
                updateCard,
                deleteCard,
                addStudySession,
                toggleTheme,
                importData,
                clearAllCards,
                toggleSpeech,
                updateCardProgress,
                getAnalytics,
            }), [state, addCard, updateCard, deleteCard, addStudySession, toggleTheme, importData, clearAllCards, toggleSpeech, updateCardProgress, getAnalytics]);
            
            return React.createElement(FlashCardsContext.Provider, { value }, [
                children,
                achievementNotification && React.createElement(AchievementNotification, {
                    key: 'achievement',
                    achievement: achievementNotification,
                    onClose: () => setAchievementNotification(null)
                })
            ]);
        }

        // Main App Component
        function MobileFlashCardsApp() {
            const { 
                state, 
                toggleTheme, 
                addCard, 
                updateCard, 
                deleteCard, 
                addStudySession, 
                importData, 
                clearAllCards, 
                toggleSpeech,
                getAnalytics 
            } = useFlashCards();
            
            const { theme, cards, categories, settings, currentStreak, totalPointsEarned } = state;
            
            const [activeView, setActiveView] = useState('cards');
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('');
            const [selectedPoints, setSelectedPoints] = useState([]);
            const [selectedTags, setSelectedTags] = useState([]);
            const [showCardEditor, setShowCardEditor] = useState(false);
            const [editingCard, setEditingCard] = useState(undefined);
            const [isStudying, setIsStudying] = useState(false);
            const [showMenu, setShowMenu] = useState(false);
            const [showPointsSelection, setShowPointsSelection] = useState(false);
            const [studyCards, setStudyCards] = useState([]);
            const [studyMode, setStudyMode] = useState('standard');
            
            const fileInputRef = useRef(null);
            
            const availableTags = useMemo(() => {
                const allTags = new Set();
                cards.forEach(card => {
                    card.tags?.forEach(tag => allTags.add(tag));
                });
                return Array.from(allTags);
            }, [cards]);
            
            const availablePoints = useMemo(() => {
                return [...new Set(cards.map(card => card.points || 1))].sort((a, b) => a - b);
            }, [cards]);
            
            const filteredCards = useMemo(() => {
                return cards.filter(card => {
                    const matchesSearch = !searchQuery || (
                        settings.fuzzySearchEnabled
                            ? fuzzyMatch(card.question, searchQuery) || fuzzyMatch(card.answer, searchQuery)
                            : card.question.toLowerCase().includes(searchQuery.toLowerCase()) ||
                              card.answer.toLowerCase().includes(searchQuery.toLowerCase())
                    );
                    
                    const matchesCategory = !selectedCategory || card.category === selectedCategory;
                    const matchesPoints = selectedPoints.length === 0 || selectedPoints.includes(card.points || 1);
                    const matchesTags = selectedTags.length === 0 || selectedTags.some(tag => card.tags?.includes(tag));
                    
                    return matchesSearch && matchesCategory && matchesPoints && matchesTags;
                });
            }, [cards, searchQuery, selectedCategory, selectedPoints, selectedTags, settings.fuzzySearchEnabled]);
            
            const dueCards = useMemo(() => {
                const now = new Date();
                return cards.filter(card => {
                    if (!card.nextReview) return card.timesStudied === 0;
                    return new Date(card.nextReview) <= now;
                });
            }, [cards]);
            
            const totalPoints = useMemo(() => {
                return cards.reduce((sum, card) => sum + (card.points || 1), 0);
            }, [cards]);
            
            useEffect(() => {
                if (activeView !== 'study' || !isStudying) {
                    SpeechService.stop();
                }
            }, [activeView, isStudying]);
            
            const handleImport = useCallback(() => {
                fileInputRef.current?.click();
                setShowMenu(false);
            }, []);
            
            const handleClearAll = useCallback(() => {
                const confirmed = confirm(
                    `Are you sure you want to delete ALL ${cards.length} cards?\n\nThis action cannot be undone and will also clear all your study progress.`
                );
                if (confirmed) {
                    SpeechService.stop();
                    clearAllCards();
                    setShowMenu(false);
                    alert('All cards have been cleared. You now have a clean slate!');
                }
            }, [cards.length, clearAllCards]);
            
            const handleFileChange = useCallback((event) => {
                const file = event.target.files?.[0];
                if (!file) return;
                
                StorageService.importData(
                    file,
                    (data) => {
                        importData(data);
                        alert(`Successfully imported ${data.cards.length} cards!`);
                    },
                    (error) => {
                        alert(`Import failed: ${error}`);
                    }
                );
                
                event.target.value = '';
            }, [importData]);
            
            const handleStudyComplete = useCallback((results) => {
                const pointsEarned = studyCards
                    .slice(0, results.correct)
                    .reduce((sum, card) => sum + (card.points || 1), 0);
                
                addStudySession({
                    date: new Date().toISOString(),
                    duration: results.duration,
                    cardsStudied: results.correct + (results.incorrect || 0),
                    correctCount: results.correct,
                    incorrectCount: results.incorrect || 0,
                    mode: results.mode || studyMode,
                    pointsEarned,
                    streakBonus: currentStreak >= 7 ? Math.floor(pointsEarned * 0.1) : 0,
                });
                
                setIsStudying(false);
                setStudyCards([]);
            }, [addStudySession, studyCards, studyMode, currentStreak]);
            
            const startStudyingCard = useCallback((card) => {
                SpeechService.stop();
                setStudyCards([card]);
                setIsStudying(true);
                setActiveView('study');
            }, []);
            
            const handlePointsSelectionForStudy = useCallback((points) => {
                const cardsToStudy = cards.filter(card => points.includes(card.points || 1));
                setStudyCards(cardsToStudy);
                setShowPointsSelection(false);
                setIsStudying(true);
            }, [cards]);
            
            const handleViewChange = useCallback((newView) => {
                SpeechService.stop();
                setActiveView(newView);
                setIsStudying(false);
            }, []);
            
            const handleCardEdit = useCallback((card) => {
                setEditingCard(card);
                setShowCardEditor(true);
            }, []);
            
            const handleCardDelete = useCallback((cardId) => {
                if (confirm('Delete this card?')) {
                    deleteCard(cardId);
                }
            }, [deleteCard]);
            
            const handleCardSave = useCallback((cardData) => {
                if (editingCard) {
                    updateCard(editingCard.id, cardData);
                } else {
                    addCard(cardData);
                }
                setShowCardEditor(false);
                setEditingCard(undefined);
            }, [editingCard, updateCard, addCard]);
            
            const handleCardEditorCancel = useCallback(() => {
                setShowCardEditor(false);
                setEditingCard(undefined);
            }, []);
            
            const analytics = useMemo(() => getAnalytics(), [getAnalytics]);
            
            return (
                <div className={`min-h-screen ${theme === 'dark' ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-900'}`}>
                    <header className={`sticky top-0 z-40 ${
                        theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'
                    } border-b backdrop-blur-md bg-opacity-90`}>
                        <div className="px-4 py-3">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <h1 className="text-xl font-bold flex items-center gap-2">
                                        <span className="bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
                                            Flash Cards Pro
                                        </span>
                                        <span className={`text-sm px-2 py-0.5 rounded-full ${
                                            theme === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-600'
                                        }`}>
                                            v{APP_VERSION} ‚ú®
                                        </span>
                                    </h1>
                                    
                                    {currentStreak > 0 && (
                                        <div className="flex items-center gap-1 text-orange-500">
                                            <Icon name="fire" className="w-4 h-4" />
                                            <span className="text-sm font-bold">{currentStreak}</span>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    <div className="flex items-center gap-1 text-yellow-500">
                                        <Icon name="points" className="w-4 h-4" />
                                        <span className="text-sm font-bold">{totalPointsEarned}</span>
                                    </div>
                                    
                                    <button
                                        onClick={toggleTheme}
                                        className={`p-2 rounded-lg ${
                                            theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                        }`}
                                    >
                                        <Icon name={theme === 'dark' ? 'sun' : 'moon'} />
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowMenu(!showMenu)}
                                        className={`p-2 rounded-lg ${
                                            theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                        }`}
                                    >
                                        <Icon name="menu" />
                                    </button>
                                </div>
                            </div>
                            
                            {activeView === 'cards' && !isStudying && (
                                <div className="mt-3 space-y-3">
                                    <EnhancedSearch
                                        searchQuery={searchQuery}
                                        onSearchChange={setSearchQuery}
                                        selectedTags={selectedTags}
                                        onTagToggle={(tag) => {
                                            setSelectedTags(prev =>
                                                prev.includes(tag)
                                                    ? prev.filter(t => t !== tag)
                                                    : [...prev, tag]
                                            );
                                        }}
                                        availableTags={availableTags}
                                        fuzzyEnabled={settings.fuzzySearchEnabled}
                                    />
                                    
                                    {availablePoints.length > 0 && (
                                        <div className="flex gap-2 overflow-x-auto pb-1">
                                            <button
                                                onClick={() => setSelectedPoints([])}
                                                className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap ${
                                                    selectedPoints.length === 0
                                                        ? 'bg-blue-500 text-white'
                                                        : theme === 'dark'
                                                        ? 'bg-gray-800 text-gray-300'
                                                        : 'bg-gray-200 text-gray-700'
                                                }`}
                                            >
                                                All Points
                                            </button>
                                            {availablePoints.map(pt => (
                                                <button
                                                    key={pt}
                                                    onClick={() => {
                                                        setSelectedPoints(prev =>
                                                            prev.includes(pt)
                                                                ? prev.filter(p => p !== pt)
                                                                : [...prev, pt]
                                                        );
                                                    }}
                                                    className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center gap-1 ${
                                                        selectedPoints.includes(pt)
                                                            ? getPointsColor(pt)
                                                            : theme === 'dark'
                                                            ? 'bg-gray-800 text-gray-300'
                                                            : 'bg-gray-200 text-gray-700'
                                                    }`}
                                                >
                                                    <Icon name="points" className="w-3 h-3" />
                                                    {pt}pt
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </header>
                    
                    {showMenu && (
                        <div className="fixed inset-0 z-50" onClick={() => setShowMenu(false)}>
                            <div className={`absolute top-16 right-4 w-52 rounded-xl shadow-lg ${
                                theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'
                            } border overflow-hidden`}>
                                <button
                                    onClick={() => {
                                        setShowCardEditor(true);
                                        setShowMenu(false);
                                    }}
                                    className={`w-full px-4 py-3 text-left flex items-center gap-3 ${
                                        theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    <Icon name="plus" className="w-4 h-4" />
                                    New Card
                                </button>
                                <button
                                    onClick={handleImport}
                                    className={`w-full px-4 py-3 text-left flex items-center gap-3 ${
                                        theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    üì• Import Cards
                                </button>
                                <button
                                    onClick={() => {
                                        StorageService.exportData(state);
                                        setShowMenu(false);
                                    }}
                                    className={`w-full px-4 py-3 text-left flex items-center gap-3 ${
                                        theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    üíæ Export Data
                                </button>
                                <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <button
                                        onClick={() => {
                                            toggleSpeech();
                                            setShowMenu(false);
                                        }}
                                        className={`w-full px-4 py-3 text-left flex items-center gap-3 ${
                                            theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                        }`}
                                    >
                                        {settings.speechEnabled ? 'üîä' : 'üîá'} Read Aloud {settings.speechEnabled ? 'ON' : 'OFF'}
                                    </button>
                                </div>
                                <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <button
                                        onClick={handleClearAll}
                                        className={`w-full px-4 py-3 text-left flex items-center gap-3 text-red-500 ${
                                            theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                        }`}
                                    >
                                        üóëÔ∏è Clear All Cards
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <input
                        ref={fileInputRef}
                        type="file"
                        accept=".txt,.json"
                        onChange={handleFileChange}
                        style={{ display: 'none' }}
                    />
                    
                    <main className="px-4 py-4 pb-20">
                        {activeView === 'cards' && !isStudying && (
                            <div className="space-y-4">
                                {categories.size > 0 && (
                                    <div className="flex gap-2 overflow-x-auto pb-2">
                                        <button
                                            onClick={() => setSelectedCategory('')}
                                            className={`px-3 py-2 rounded-xl text-sm font-medium whitespace-nowrap ${
                                                !selectedCategory
                                                    ? 'bg-blue-500 text-white'
                                                    : theme === 'dark'
                                                    ? 'bg-gray-800 text-gray-300'
                                                    : 'bg-gray-200 text-gray-700'
                                            }`}
                                        >
                                            All
                                        </button>
                                        {Array.from(categories).map(cat => (
                                            <button
                                                key={cat}
                                                onClick={() => setSelectedCategory(cat)}
                                                className={`px-3 py-2 rounded-xl text-sm font-medium whitespace-nowrap ${
                                                    selectedCategory === cat
                                                        ? 'bg-blue-500 text-white'
                                                        : theme === 'dark'
                                                        ? 'bg-gray-800 text-gray-300'
                                                        : 'bg-gray-200 text-gray-700'
                                                }`}
                                            >
                                                {cat}
                                            </button>
                                        ))}
                                    </div>
                                )}
                                
                                {filteredCards.length === 0 ? (
                                    <div className="text-center py-12">
                                        <Icon name="study" className="w-16 h-16 mx-auto mb-4 text-gray-400" />
                                        <p className="text-lg mb-2">No cards found</p>
                                        <p className="text-gray-500 mb-4">
                                            {searchQuery || selectedTags.length > 0 || selectedPoints.length > 0
                                                ? 'Try adjusting your search filters'
                                                : 'Create your first card to get started!'
                                            }
                                        </p>
                                        {!searchQuery && selectedTags.length === 0 && selectedPoints.length === 0 && (
                                            <button
                                                onClick={() => setShowCardEditor(true)}
                                                className="px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-medium"
                                            >
                                                Create Card
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {filteredCards.map(card => (
                                            <MobileCardItem
                                                key={card.id}
                                                card={card}
                                                onEdit={() => handleCardEdit(card)}
                                                onDelete={() => handleCardDelete(card.id)}
                                                onStudy={() => startStudyingCard(card)}
                                            />
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {activeView === 'study' && !isStudying && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-center mb-6">Ready to Study? üìö</h2>
                                
                                {settings.spacedRepetitionEnabled && dueCards.length > 0 && (
                                    <div className={`p-6 rounded-xl ${
                                        theme === 'dark' ? 'bg-gradient-to-r from-purple-900 to-purple-800' : 'bg-gradient-to-r from-purple-100 to-purple-200'
                                    } text-center border-2 border-purple-500`}>
                                        <Icon name="brain" className="w-12 h-12 mx-auto mb-4 text-purple-500" />
                                        <h3 className="text-lg font-semibold mb-2">üß† Smart Review</h3>
                                        <p className={`text-sm mb-4 ${
                                            theme === 'dark' ? 'text-purple-200' : 'text-purple-700'
                                        }`}>
                                            {dueCards.length} cards are due for review using spaced repetition
                                        </p>
                                        
                                        <button
                                            onClick={() => {
                                                setStudyCards(dueCards);
                                                setStudyMode('spaced-repetition');
                                                setIsStudying(true);
                                            }}
                                            className="w-full py-4 bg-purple-500 text-white rounded-xl hover:bg-purple-600 text-lg font-medium"
                                        >
                                            Start Smart Review ({dueCards.length} cards)
                                        </button>
                                    </div>
                                )}
                                
                                <div className={`p-6 rounded-xl ${
                                    theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                                } text-center`}>
                                    <Icon name="study" className="w-12 h-12 mx-auto mb-4 text-blue-500" />
                                    <h3 className="text-lg font-semibold mb-2">Study Session</h3>
                                    <p className={`text-sm mb-4 ${
                                        theme === 'dark' ? 'text-gray-400' : 'text-gray-600'
                                    }`}>
                                        Choose how you want to study your {filteredCards.length} flashcards
                                    </p>
                                    
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => setShowPointsSelection(true)}
                                            disabled={filteredCards.length === 0}
                                            className="w-full py-4 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-lg font-medium"
                                        >
                                            Study by Points
                                        </button>
                                        
                                        <button
                                            onClick={() => {
                                                setStudyCards(filteredCards);
                                                setStudyMode('standard');
                                                setIsStudying(true);
                                            }}
                                            disabled={filteredCards.length === 0}
                                            className="w-full py-4 bg-green-500 text-white rounded-xl hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed text-lg font-medium"
                                        >
                                            Study All ({filteredCards.length} cards)
                                        </button>
                                    </div>
                                </div>
                                
                                <div className={`grid grid-cols-3 gap-3 ${
                                    theme === 'dark' ? 'text-gray-300' : 'text-gray-700'
                                }`}>
                                    {[1, 2, 3, 4, 5, 6].map(pt => {
                                        const count = cards.filter(c => (c.points || 1) === pt).length;
                                        if (count === 0) return null;
                                        return (
                                            <div key={pt} className={`p-3 rounded-lg text-center ${
                                                theme === 'dark' ? 'bg-gray-800' : 'bg-gray-100'
                                            }`}>
                                                <div className={`text-xs px-2 py-1 rounded inline-flex items-center gap-1 mb-1 ${getPointsColor(pt)}`}>
                                                    <Icon name="points" className="w-3 h-3" />
                                                    {pt}pt
                                                </div>
                                                <div className="text-sm font-medium">{count} cards</div>
                                            </div>
                                        );
                                    }).filter(Boolean)}
                                </div>
                            </div>
                        )}
                        
                        {isStudying && studyMode === 'spaced-repetition' && (
                            <SpacedRepetitionStudyMode
                                cards={studyCards}
                                onComplete={handleStudyComplete}
                            />
                        )}
                        
                        {isStudying && studyMode === 'standard' && (
                            <StandardStudyMode
                                cards={studyCards}
                                onComplete={handleStudyComplete}
                            />
                        )}
                        
                        {activeView === 'stats' && (
                            <div className="space-y-6">
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold mb-2">Your Progress üìä</h2>
                                    <div className="flex justify-center gap-4 text-sm">
                                        <div className="flex items-center gap-1">
                                            <Icon name="fire" className="w-4 h-4 text-orange-500" />
                                            <span>{currentStreak} day streak</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <Icon name="points" className="w-4 h-4 text-yellow-500" />
                                            <span>{totalPointsEarned} points earned</span>
                                        </div>
                                    </div>
                                </div>
                                
                                {state.achievements.length > 0 && (
                                    <div className={`p-4 rounded-xl ${theme === 'dark' ? 'bg-gray-800' : 'bg-white'}`}>
                                        <h3 className="font-semibold mb-3">üèÜ Achievements</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            {state.achievements.slice(-4).map(achievement => (
                                                <div key={achievement.id} className={`p-3 rounded-lg text-center ${
                                                    theme === 'dark' ? 'bg-gray-700' : 'bg-gray-100'
                                                }`}>
                                                    <div className="text-2xl mb-1">{achievement.icon}</div>
                                                    <div className="text-xs font-medium">{achievement.title}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                <AnalyticsDashboard analytics={analytics} />
                            </div>
                        )}
                    </main>
                    
                    <nav className={`fixed bottom-0 left-0 right-0 ${
                        theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'
                    } border-t px-4 py-2`}>
                        <div className="flex justify-around">
                            <button
                                onClick={() => handleViewChange('cards')}
                                className={`flex flex-col items-center py-2 px-4 rounded-lg transition-colors ${
                                    activeView === 'cards'
                                        ? 'text-blue-500'
                                        : theme === 'dark' ? 'text-gray-400 hover:text-gray-300' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                <Icon name="cards" className="w-5 h-5" />
                                <span className="text-xs mt-1">Cards</span>
                                {filteredCards.length > 0 && (
                                    <span className="text-xs bg-blue-500 text-white rounded-full px-1 min-w-[16px] h-4 flex items-center justify-center mt-1">
                                        {filteredCards.length}
                                    </span>
                                )}
                            </button>
                            
                            <button
                                onClick={() => handleViewChange('study')}
                                className={`flex flex-col items-center py-2 px-4 rounded-lg transition-colors relative ${
                                    activeView === 'study'
                                        ? 'text-blue-500'
                                        : theme === 'dark' ? 'text-gray-400 hover:text-gray-300' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                <Icon name="study" className="w-5 h-5" />
                                <span className="text-xs mt-1">Study</span>
                                {dueCards.length > 0 && (
                                    <span className="absolute -top-1 -right-1 text-xs bg-red-500 text-white rounded-full px-1 min-w-[16px] h-4 flex items-center justify-center">
                                        {dueCards.length}
                                    </span>
                                )}
                            </button>
                            
                            <button
                                onClick={() => handleViewChange('stats')}
                                className={`flex flex-col items-center py-2 px-4 rounded-lg transition-colors ${
                                    activeView === 'stats'
                                        ? 'text-blue-500'
                                        : theme === 'dark' ? 'text-gray-400 hover:text-gray-300' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                <Icon name="stats" className="w-5 h-5" />
                                <span className="text-xs mt-1">Stats</span>
                            </button>
                        </div>
                    </nav>
                    
                    {showCardEditor && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center p-4 z-50 overflow-y-auto">
                            <div className={`w-full max-w-md mt-8 mb-8 rounded-2xl p-6 ${
                                theme === 'dark' ? 'bg-gray-900' : 'bg-white'
                            }`}>
                                <h3 className="text-xl font-semibold mb-6">
                                    {editingCard ? 'Edit Card' : 'Create New Card'}
                                </h3>
                                <MobileCardEditor
                                    card={editingCard}
                                    onSave={handleCardSave}
                                    onCancel={handleCardEditorCancel}
                                />
                            </div>
                        </div>
                    )}
                    
                    {showPointsSelection && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className={`w-full max-w-sm rounded-2xl p-6 ${
                                theme === 'dark' ? 'bg-gray-900' : 'bg-white'
                            }`}>
                                <h3 className="text-xl font-semibold mb-2">Study by Points üèÜ</h3>
                                <p className={`text-sm mb-4 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Select which point values to practice.
                                </p>
                                
                                <div className="grid grid-cols-3 gap-3 mb-4">
                                    {availablePoints.map(point => {
                                        const count = cards.filter(c => (c.points || 1) === point).length;
                                        return (
                                            <label key={point} className="cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedPoints.includes(point)}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setSelectedPoints([...selectedPoints, point]);
                                                        } else {
                                                            setSelectedPoints(selectedPoints.filter(p => p !== point));
                                                        }
                                                    }}
                                                    className="sr-only"
                                                />
                                                <div className={`py-3 rounded-xl border transition-all text-center ${
                                                    selectedPoints.includes(point)
                                                        ? getPointsColor(point) + ' border-transparent'
                                                        : theme === 'dark'
                                                        ? 'border-gray-700 hover:border-gray-600'
                                                        : 'border-gray-300 hover:border-gray-400'
                                                }`}>
                                                    <div className="flex flex-col items-center">
                                                        <div className="flex items-center gap-1">
                                                            <Icon name="points" className="w-4 h-4" />
                                                            <span className="font-medium">{point}pt</span>
                                                        </div>
                                                        <span className="text-xs opacity-75 mt-1">{count} cards</span>
                                                    </div>
                                                </div>
                                            </label>
                                        );
                                    })}
                                </div>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowPointsSelection(false)}
                                        className={`flex-1 py-3 rounded-xl border ${
                                            theme === 'dark' 
                                                ? 'border-gray-700 hover:bg-gray-800' 
                                                : 'border-gray-300 hover:bg-gray-100'
                                        } transition-colors font-medium`}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => handlePointsSelectionForStudy(selectedPoints)}
                                        disabled={selectedPoints.length === 0}
                                        className="flex-1 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
                                    >
                                        Start Study
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function App() {
            return (
                <ErrorBoundary>
                    <FlashCardsProvider>
                        <MobileFlashCardsApp />
                    </FlashCardsProvider>
                </ErrorBoundary>
            );
        }

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>
